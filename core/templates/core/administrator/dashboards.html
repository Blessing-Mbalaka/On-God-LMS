{% extends "core/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Analytics Dashboard | CHIETA{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" referrerpolicy="no-referrer" />
<style>
:root {
    --chi-purple: #3a063a;
    --chi-purple-dark: #280427;
    --chi-purple-200: #580658;
    --chi-gold: #8f6620;
    --chi-sand: #b8832a;
    --chi-slate: #403675;
}
body {
    margin: 0;
    font-family: Georgia, 'Times New Roman', Times, serif;
    background-color: #ecf0f1;
}
main.container {
    max-width: 100%;
    padding-left: 0;
    padding-right: 0;
}
button:hover {
    background-color: #ffffff;
    color: #4d4747;
    border-color: #007BFF;
}
.dashboard-container {
    display: flex;
    flex-direction: row;
    min-height: 100vh;
}
.sidebar {
    width: 210px;
    min-height: 100vh;
    font-size: 13px;
    background: linear-gradient(to bottom, rgb(195, 193, 193), white, rgb(160, 160, 160), rgb(240, 239, 239), rgb(240, 239, 239), rgb(91, 60, 131));
    padding: 20px;
    border-right: 1px solid #8f6620;
    box-shadow: inset 0 -2px 3px rgba(75, 0, 130, 0.7);
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1000;
    overflow-y: auto;
}
.sidebar .graduate-icon {
    border-radius: 20px;
    height: 110px;
    width: 105px;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-left: auto;
    margin-right: auto;
}
.sidebar ul {
    list-style-type: none;
    padding: 0;
}
.sidebar ul li {
    margin: 20px 0;
    display: flex;
    align-items: center;
    transition: background-color 0.3s ease;
    border-top: 1.5px solid #580658;
    border-radius: 10px;
    color: #580658;
}
.sidebar ul li i {
    margin-right: 10px;
}
.sidebar ul li:hover {
    background-color: #8f6620;
    color: white;
    cursor: pointer;
    border-radius: 10px;
    height: 30px;
}
.nav-link {
    color: rgb(81, 3, 102);
    text-decoration: none;
    display: flex;
    align-items: center;
    padding: 10px 14px;
    width: 100%;
    transition: color 0.3s;
}
.nav-link:hover,
.nav-link.active,
.sidebar ul li:hover .nav-link {
    color: rgb(249, 249, 249);
}
.nav-link.active {
    background-color: #8f6620;
    border-radius: 10px;
}
.gradient-button {
    background-color: #3a063a;
    color: white;
    border: none;
    border-radius: 25px;
    padding: 10px 20px;
    font-size: 12px;
    margin-top: 10px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}
.gradient-button:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
    background-color: #8f6620;
}
.fix {
    width: 100%;
    height: 40px;
    border-radius: 10px;
    color: whitesmoke;
    border-color: #f9f9f9;
    background-color: #3a063a;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
}
.content {
    flex-grow: 1;
    padding: 20px;
    margin-left: 240px;
    width: calc(100% - 240px);
    background-color: #efeaea;
    background-image: url("{% static 'core/images/Frame.png' %}");
    background-repeat: no-repeat;
    background-size: cover;
    min-height: 100vh;
    opacity: 0.9;
}
.topbar {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
}
.topbar input[type="search"] {
    padding: 10px;
    width: 70%;
    border-radius: 20px;
    border: 1px solid #ccc;
    background-color: rgba(255, 255, 255, 0.92);
}
.dashboard-page {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 18px;
    padding: 24px;
    box-shadow: 0 25px 45px rgba(58, 6, 58, 0.12);
}
.page-heading {
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--chi-purple-dark);
}
.text-accent {
    color: var(--chi-purple);
}
.dashboard-filter label {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: .08em;
    color: #6f587d;
    font-weight: 600;
}
.dashboard-filter .form-select,
.dashboard-filter .form-control {
    min-width: 160px;
}
.stat-card {
    background: linear-gradient(135deg, var(--chi-purple), var(--chi-purple-200));
    color: #fff;
    border-radius: 1rem;
    padding: 1.4rem;
    min-height: 160px;
    box-shadow: 0 10px 24px rgba(58, 6, 58, 0.18);
    display: flex;
    flex-direction: column;
    gap: .4rem;
    position: relative;
    overflow: hidden;
}
.stat-card[data-variant="gold"] {
    background: linear-gradient(135deg, var(--chi-gold), var(--chi-sand));
}
.stat-card[data-variant="slate"] {
    background: linear-gradient(135deg, var(--chi-slate), #6c4aa0);
}
.stat-card[data-variant="neutral"] {
    background: #fff;
    color: var(--chi-purple-dark);
    border: 1px solid rgba(90, 62, 123, 0.12);
    box-shadow: 0 8px 16px rgba(40, 4, 39, 0.08);
}
.stat-card .stat-label {
    text-transform: uppercase;
    font-size: .72rem;
    letter-spacing: .12em;
    font-weight: 700;
    opacity: .85;
}
.stat-card[data-variant="neutral"] .stat-label {
    color: #6f6f6f;
}
.stat-card .stat-value {
    font-size: 2.4rem;
    font-weight: 700;
}
.stat-card .stat-foot {
    margin-top: auto;
}
.stat-chip {
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    background: rgba(255, 255, 255, 0.14);
    padding: .2rem .6rem;
    border-radius: 999px;
    font-size: .75rem;
    font-weight: 600;
}
[data-variant="neutral"] .stat-chip {
    background: rgba(58, 6, 58, 0.08);
    color: var(--chi-purple);
}
.card.shadow-sm {
    border-radius: 1rem;
    border: 1px solid rgba(88, 6, 88, 0.12);
}
.card-header {
    border-bottom: 0;
    background: transparent;
    font-weight: 600;
    color: var(--chi-purple-dark);
    padding: 1rem 1.5rem 0;
}
.card-body {
    padding: 1rem 1.5rem 1.5rem;
}
.chart-canvas {
    width: 100%;
    height: 100%;
    min-height: 260px;
}
.chart-empty {
    border: 1px dashed rgba(58, 6, 58, 0.25);
    border-radius: .75rem;
    padding: 1rem;
    text-align: center;
    font-style: italic;
    font-size: .9rem;
    margin: .5rem 0 0;
}
.table-dashboard thead {
    background: linear-gradient(90deg, rgba(58, 6, 58, 0.85), rgba(143, 102, 32, 0.85));
    color: #fff;
}
.table-dashboard tbody tr:hover {
    background-color: rgba(143, 102, 32, 0.08);
}
.badge-pass-strong {
    background-color: #2f9d57;
}
.badge-pass-mid {
    background-color: #f6c343;
    color: #3a063a;
}
.badge-pass-low {
    background-color: #e55353;
}
.metric-kpi {
    font-size: .85rem;
    font-weight: 600;
}
.metric-kpi .trend-up {
    color: #2f9d57;
}
.metric-kpi .trend-down {
    color: #e55353;
}
@media (max-width: 992px) {
    .dashboard-container {
        flex-direction: column;
    }
    .sidebar {
        position: relative;
        width: 100%;
        min-height: auto;
        margin-bottom: 1.5rem;
    }
    .content {
        margin-left: 0;
        width: 100%;
        padding: 20px 15px 40px;
    }
    .topbar input[type="search"] {
        width: 80%;
    }
    .dashboard-filter .form-select,
    .dashboard-filter .form-control {
        min-width: 0;
    }
    .stat-card {
        min-height: 140px;
    }
    .chart-canvas {
        min-height: 220px;
    }
}
</style>

{% endblock %}

{% block content %}
<div class="dashboard-container">
    {% include "core/administrator/_sidebar.html" %}
    <div class="content">
        <div class="topbar">
            <input type="search" placeholder="Search analytics...">
        </div>
        <div class="dashboard-page">
    <div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-4">
        <div>
            <h1 class="page-heading mb-1">
                <i class="fas fa-chart-line me-2 text-accent"></i>
                Analytics Dashboard
            </h1>
            <p class="text-muted mb-0">Live indicators sourced from assessments, submissions, and learner records.</p>
        </div>
        <form method="get" class="row g-2 dashboard-filter align-items-end">
            <div class="col-auto">
                <label class="form-label">Qualification</label>
                <select class="form-select form-select-sm" name="qualification">
                    <option value="">All</option>
                    {% if qualifications %}
                        {% for qualification in qualifications %}
                            {% with qid=qualification.id|stringformat:"s" %}
                                <option value="{{ qid }}" {% if request.GET.qualification == qid %}selected{% endif %}>
                                    {{ qualification.name }}
                                </option>
                            {% endwith %}
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div class="col-auto">
                <label class="form-label">Period</label>
                <select class="form-select form-select-sm" name="period">
                    {% if period_options %}
                        {% for value,label in period_options %}
                            <option value="{{ value }}" {% if request.GET.period == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    {% else %}
                        {% with current=request.GET.period %}
                            <option value="30d" {% if current == "30d" or not current %}selected{% endif %}>Last 30 days</option>
                            <option value="90d" {% if current == "90d" %}selected{% endif %}>Last 90 days</option>
                            <option value="365d" {% if current == "365d" %}selected{% endif %}>Last 12 months</option>
                        {% endwith %}
                    {% endif %}
                </select>
            </div>
            <div class="col-auto">
                <label class="form-label">Assessment type</label>
                <select class="form-select form-select-sm" name="paper_type">
                    <option value="">All types</option>
                    {% if assessment_type_choices %}
                        {% for value,label in assessment_type_choices %}
                            <option value="{{ value }}" {% if request.GET.paper_type == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div class="col-auto">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button type="submit" class="btn btn-primary btn-sm px-3">Apply</button>
                    {% if request.GET %}
                        <a href="{{ request.path }}" class="btn btn-outline-secondary btn-sm ms-1">Reset</a>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>

    {% with metrics=metrics %}
    <div class="row g-3 mb-4">
        <div class="col-sm-6 col-xl-3">
            <div class="stat-card">
                <span class="stat-label">Registered learners</span>
                <span class="stat-value">
                    {{ metrics.total_learners|default:0|intcomma }}
                </span>
                <span class="stat-foot stat-chip">
                    <i class="fas fa-graduation-cap me-1"></i>
                    {{ metrics.active_qualifications|default:0|intcomma }} active qualifications
                </span>
            </div>
        </div>
        <div class="col-sm-6 col-xl-3">
            <div class="stat-card" data-variant="gold">
                <span class="stat-label">Assessments completed</span>
                <span class="stat-value">
                    {{ metrics.completed_assessments|default:0|intcomma }}
                </span>
                <span class="stat-foot metric-kpi">
                    {% with delta=metrics.completed_assessments_delta %}
                        {% if delta or delta == 0 %}
                            {% if delta >= 0 %}
                                <span class="trend-up">
                                    <i class="fas fa-arrow-up me-1"></i>{{ delta|floatformat:1 }}% vs prev.
                                </span>
                            {% else %}
                                <span class="trend-down">
                                    <i class="fas fa-arrow-down me-1"></i>{{ delta|floatformat:1 }}% vs prev.
                                </span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Change data not available</span>
                        {% endif %}
                    {% endwith %}
                </span>
            </div>
        </div>
        <div class="col-sm-6 col-xl-3">
            <div class="stat-card" data-variant="slate">
                <span class="stat-label">Overall pass rate</span>
                <span class="stat-value">
                    {{ metrics.overall_pass_rate|default:0|floatformat:1 }}%
                </span>
                <span class="stat-foot metric-kpi">
                    {% with rate_delta=metrics.pass_rate_delta %}
                        {% if rate_delta or rate_delta == 0 %}
                            {% if rate_delta >= 0 %}
                                <span class="trend-up">
                                    <i class="fas fa-arrow-up me-1"></i>{{ rate_delta|floatformat:1 }}pts gain
                                </span>
                            {% else %}
                                <span class="trend-down">
                                    <i class="fas fa-arrow-down me-1"></i>{{ rate_delta|floatformat:1 }}pts drop
                                </span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">No comparative period selected</span>
                        {% endif %}
                    {% endwith %}
                </span>
            </div>
        </div>
        <div class="col-sm-6 col-xl-3">
            <div class="stat-card" data-variant="neutral">
                <span class="stat-label">Randomized papers</span>
                <span class="stat-value text-accent">
                    {{ metrics.randomized_papers|default:0|intcomma }}
                </span>
                <span class="stat-foot metric-kpi">
                    <span class="stat-chip">
                        {{ metrics.randomized_share|default:0|floatformat:1 }}% of active tools
                    </span>
                </span>
            </div>
        </div>
    </div>
    {% endwith %}

    <div class="row g-3 mb-4">
        <div class="col-lg-6">
            <div class="card shadow-sm h-100" id="pass-rate-card">
                <div class="card-header">Pass rate by qualification</div>
                <div class="card-body">
                    <canvas aria-label="Pass rate by qualification" role="img" class="chart-canvas"></canvas>
                    <p class="chart-empty text-muted small mb-0">No pass rate data available for the current filters.</p>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-sm h-100" id="completion-card">
                <div class="card-header">Assessment completion trend</div>
                <div class="card-body">
                    <canvas aria-label="Assessment completion trend" role="img" class="chart-canvas"></canvas>
                    <p class="chart-empty text-muted small mb-0">No completion trend data available for the selected window.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-lg-4">
            <div class="card shadow-sm h-100" id="assessment-type-card">
                <div class="card-header">Assessment type mix</div>
                <div class="card-body">
                    <canvas aria-label="Assessment type distribution" role="img" class="chart-canvas"></canvas>
                    <p class="chart-empty text-muted small mb-0">No assessment type distribution recorded.</p>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card shadow-sm h-100" id="enrollment-card">
                <div class="card-header">Learner enrollment by qualification</div>
                <div class="card-body">
                    <canvas aria-label="Enrollment by qualification" role="img" class="chart-canvas"></canvas>
                    <p class="chart-empty text-muted small mb-0">No enrollment data available.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header">Qualification performance detail</div>
        {% if course_statistics %}
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dashboard table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th scope="col" class="ps-4">Qualification</th>
                                <th scope="col">Learners</th>
                                <th scope="col">Completed</th>
                                <th scope="col">Pass rate</th>
                                <th scope="col">Average score</th>
                                <th scope="col">Written papers</th>
                                <th scope="col">Randomized</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for course in course_statistics %}
                                <tr>
                                    <td class="ps-4">
                                        <div class="fw-semibold">{{ course.qualification|default:"-" }}</div>
                                        {% if course.latest_assessment %}
                                            <div class="text-muted small">Latest tool: {{ course.latest_assessment }}</div>
                                        {% endif %}
                                    </td>
                                    <td>{{ course.total_learners|default:0|intcomma }}</td>
                                    <td>{{ course.completed_learners|default:0|intcomma }}</td>
                                    <td>
                                        {% with rate=course.pass_rate %}
                                            {% if rate or rate == 0 %}
                                                {% if rate >= 75 %}
                                                    <span class="badge badge-pass-strong">{{ rate|floatformat:0 }}%</span>
                                                {% elif rate >= 50 %}
                                                    <span class="badge badge-pass-mid">{{ rate|floatformat:0 }}%</span>
                                                {% else %}
                                                    <span class="badge badge-pass-low">{{ rate|floatformat:0 }}%</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted small">n/a</span>
                                            {% endif %}
                                        {% endwith %}
                                    </td>
                                    <td>
                                        {% if course.average_score or course.average_score == 0 %}
                                            {{ course.average_score|floatformat:1 }}%
                                        {% else %}
                                            <span class="text-muted small">n/a</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ course.written_count|default:0|intcomma }}</td>
                                    <td>{{ course.randomized_count|default:0|intcomma }}</td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-muted">No qualification level metrics match the selected filters.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <div class="card-body">
                <p class="text-muted mb-0">No qualification level metrics are available for the selected filters.</p>
            </div>
        {% endif %}
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" integrity="sha384-SSU6RtWLpmjHtkobaN6D+PfYZ7RJJdcXumP5VcwpcKuZ4uiHPcU1CxUPCl995QPu" crossorigin="anonymous"></script>
{% if pass_rate_data %}
    {{ pass_rate_data|json_script:"pass-rate-data" }}
{% else %}
    <script id="pass-rate-data" type="application/json">[]</script>
{% endif %}
{% if completion_trend_data %}
    {{ completion_trend_data|json_script:"completion-trend-data" }}
{% else %}
    <script id="completion-trend-data" type="application/json">[]</script>
{% endif %}
{% if assessment_type_breakdown %}
    {{ assessment_type_breakdown|json_script:"assessment-type-data" }}
{% else %}
    <script id="assessment-type-data" type="application/json">{}</script>
{% endif %}
{% if enrollment_by_course_data %}
    {{ enrollment_by_course_data|json_script:"enrollment-data" }}
{% else %}
    <script id="enrollment-data" type="application/json">[]</script>
{% endif %}
<script>
(function () {
    function safeParse(id, fallback) {
        var el = document.getElementById(id);
        if (!el) { return fallback; }
        var payload = el.textContent && el.textContent.trim();
        if (!payload) { return fallback; }
        try {
            return JSON.parse(payload);
        } catch (err) {
            console.warn("Unable to parse dataset for", id, err);
            return fallback;
        }
    }

    function toggleEmptyState(container, hasData) {
        if (!container) { return; }
        var canvas = container.querySelector("canvas");
        var empty = container.querySelector(".chart-empty");
        if (canvas) {
            canvas.classList.toggle("d-none", !hasData);
        }
        if (empty) {
            empty.classList.toggle("d-none", !!hasData);
        }
    }

    var passRateContainer = document.getElementById("pass-rate-card");
    var passRateDataset = safeParse("pass-rate-data", []);
    var hasPassRate = Array.isArray(passRateDataset) && passRateDataset.length > 0;
    toggleEmptyState(passRateContainer, hasPassRate);
    if (hasPassRate) {
        new Chart(passRateContainer.querySelector("canvas"), {
            type: "bar",
            data: {
                labels: passRateDataset.map(function (row) { return row.qualification || row.name || "Qualification"; }),
                datasets: [{
                    label: "Pass rate (%)",
                    data: passRateDataset.map(function (row) { return Number(row.pass_rate || row.value || 0); }),
                    backgroundColor: passRateDataset.map(function (_, idx) {
                        var palette = ["#3a063a", "#580658", "#8f6620", "#b8832a", "#403675"];
                        return palette[idx % palette.length];
                    }),
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { callback: function (value) { return value + "%"; } }
                    }
                }
            }
        });
    }

    var completionContainer = document.getElementById("completion-card");
    var completionDataset = safeParse("completion-trend-data", []);
    var hasCompletion = Array.isArray(completionDataset) && completionDataset.length > 0;
    toggleEmptyState(completionContainer, hasCompletion);
    if (hasCompletion) {
        new Chart(completionContainer.querySelector("canvas"), {
            type: "line",
            data: {
                labels: completionDataset.map(function (row) { return row.label || row.period || row.month || ""; }),
                datasets: [{
                    label: "Assessments completed",
                    data: completionDataset.map(function (row) { return Number(row.completed || row.value || 0); }),
                    borderColor: "#3a063a",
                    backgroundColor: "rgba(58, 6, 58, 0.12)",
                    tension: 0.4,
                    fill: true,
                    pointRadius: 3,
                    pointBackgroundColor: "#3a063a"
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    var typeContainer = document.getElementById("assessment-type-card");
    var typeDataset = safeParse("assessment-type-data", {});
    var typeEntries = [];
    if (typeDataset && typeof typeDataset === "object") {
        Object.keys(typeDataset).forEach(function (key) {
            var val = Number(typeDataset[key]);
            if (!isNaN(val) && val > 0) {
                typeEntries.push({ label: key, value: val });
            }
        });
    }
    toggleEmptyState(typeContainer, typeEntries.length > 0);
    if (typeEntries.length > 0) {
        new Chart(typeContainer.querySelector("canvas"), {
            type: "doughnut",
            data: {
                labels: typeEntries.map(function (row) { return row.label; }),
                datasets: [{
                    data: typeEntries.map(function (row) { return row.value; }),
                    backgroundColor: ["#3a063a", "#8f6620", "#b8832a", "#403675", "#9478b8"]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: "bottom" }
                }
            }
        });
    }

    var enrollmentContainer = document.getElementById("enrollment-card");
    var enrollmentDataset = safeParse("enrollment-data", []);
    var hasEnrollment = Array.isArray(enrollmentDataset) && enrollmentDataset.length > 0;
    toggleEmptyState(enrollmentContainer, hasEnrollment);
    if (hasEnrollment) {
        new Chart(enrollmentContainer.querySelector("canvas"), {
            type: "bar",
            data: {
                labels: enrollmentDataset.map(function (row) { return row.qualification || row.name || ""; }),
                datasets: [{
                    label: "Learners",
                    data: enrollmentDataset.map(function (row) { return Number(row.learners || row.count || 0); }),
                    backgroundColor: "#580658",
                    borderRadius: 8
                }]
            },
            options: {
                indexAxis: "y",
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });
    }
})();
</script>
{% endblock %}




