{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Assessor Developer Reports | CHIETA</title>
  <!-- Global CSS -->
  <link rel="stylesheet" href="{% static 'core/css/dashboard.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
  <div class="dashboard-container">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="graduate-icon">
        <a href="{% url 'assessor_dashboard' %}">
          <img src="{% static 'core/images/logo_simplebbbbbbbbbbbbbb.png' %}" alt="CHIETA Logo">
        </a>
      </div>

      <ul class="sidebar-nav">
        <li class="nav-item">
          <a class="nav-link{% if request.resolver_match.url_name == 'assessor_dashboard' %} active{% endif %}"
             href="{% url 'assessor_dashboard' %}">
            <i class="fa fa-home"></i>
            <span>Dashboard</span>
          </a>
        </li>
        
        <li class="nav-item">
          <a class="nav-link{% if request.resolver_match.url_name == 'assessor_developer' %} active{% endif %}"
             href="{% url 'assessor_developer' %}">
            <i class="fa fa-cogs"></i>
            <span>Generate Assessment</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link{% if request.resolver_match.url_name == 'assessment_archive' %} active{% endif %}"
             href="{% url 'assessment_archive' %}">
            <i class="fa fa-archive"></i>
            <span>Assessment History</span>
          </a>
        </li>
        <!-- <li class="nav-item">
          <a class="nav-link{% if request.resolver_match.url_name == 'assessor_reports' %} active{% endif %}"
             href="{% url 'assessor_reports' %}">
            <i class="fa fa-chart-bar"></i>
            <span>Reports</span>
          </a>
        </li> -->

        <!-- Placeholder items -->
        <li class="nav-item">
          <a class="nav-link" href="#">
            <i class="fa fa-bell"></i>
            <span>Notifications</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">
            <i class="fa fa-life-ring"></i>
            <span>Help &amp; Support</span>
          </a>
        </li>

        <!-- Settings / Logout Buttons -->
        <li class="nav-item mt-4">
          <button class="gradient-button w-100">
            <i class="fa fa-cog"></i>
            <span>Settings</span>
          </button>
        </li>
        <li class="nav-item mt-2">
          <button class="gradient-button w-100">
            <i class="fa fa-sign-out-alt"></i>
          <a href="{% url 'logout' %}" class="fix">ðŸšª Log Out</a><br>
          </button>
        </li>
      </ul>

      <div class="sidebar-footer">
        <img src="{% static 'core/images/rb_2149331949.png' %}" alt="Sidebar Art">
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="content p-4">
      <h2 class="text-center">Assessor Developer Reports</h2>
      <p class="text-center">Overview of tool generation and submission activities</p>

      <!-- 1) Summary Cards -->
      <div class="summary-cards">
        <div class="card">
          <h3>Tools Generated</h3>
          <div class="number" id="toolsGenerated">0</div>
        </div>
        <div class="card">
          <h3>Tools Submitted</h3>
          <div class="number" id="toolsSubmitted">0</div>
        </div>
        <div class="card">
          <h3>Questions Added to Databank</h3>
          <div class="number" id="questionsAdded">0</div>
        </div>
      </div>

      <!-- 2) Filters -->
      <div class="filter-bar">
        <select id="qualificationFilter" class="form-control w-auto d-inline-block">
          <option value="">All Qualifications</option>
          {% for entry in report_list %}
            <option value="{{ entry.qualification }}">{{ entry.qualification }}</option>
          {% endfor %}
        </select>
        <button class="export-btn btn btn-outline-secondary ms-2" id="exportBtn">ðŸ“¤ Export CSV</button>
      </div>

      <!-- 3) Chart -->
      <canvas id="assessorChart" height="120"></canvas>
    </div>
  </div>

  <!-- pass the JSON string into JS -->
  <script>
    const rawReportData = {{ report_data|safe }};
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Page-specific JS -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let data = rawReportData;
      const qualificationFilter = document.getElementById('qualificationFilter');
      const toolsGenEl       = document.getElementById('toolsGenerated');
      const toolsSubEl       = document.getElementById('toolsSubmitted');
      const questionsEl      = document.getElementById('questionsAdded');
      const ctx              = document.getElementById('assessorChart').getContext('2d');

      // Initialize Chart.js
      const chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => d.qualification),
          datasets: [
            { label: 'Tools Generated', data: data.map(d => d.toolsGenerated) },
            { label: 'Tools Submitted', data: data.map(d => d.toolsSubmitted) },
            { label: 'Questions Added', data: data.map(d => d.questionsAdded) }
          ]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });

      function renderSummaries(filter) {
        const subset = filter
          ? data.filter(d => d.qualification === filter)
          : data;
        toolsGenEl.textContent  = subset.reduce((sum,d) => sum + d.toolsGenerated, 0);
        toolsSubEl.textContent  = subset.reduce((sum,d) => sum + d.toolsSubmitted, 0);
        questionsEl.textContent = subset.reduce((sum,d) => sum + d.questionsAdded, 0);
      }

      qualificationFilter.addEventListener('change', () => {
        const q = qualificationFilter.value;
        renderSummaries(q);
        if (q) {
          const idx = data.findIndex(d => d.qualification === q);
          chart.data.labels = [q];
          chart.data.datasets.forEach(ds => {
            const key = ds.label.replace(/\s/g,'').toLowerCase();
            ds.data = [data[idx][key]];
          });
        } else {
          chart.data.labels = data.map(d => d.qualification);
          chart.data.datasets[0].data = data.map(d => d.toolsGenerated);
          chart.data.datasets[1].data = data.map(d => d.toolsSubmitted);
          chart.data.datasets[2].data = data.map(d => d.questionsAdded);
        }
        chart.update();
      });

      document.getElementById('exportBtn').addEventListener('click', () => {
        const rows = [
          ['Qualification','Tools Generated','Tools Submitted','Questions Added'],
          ...data.map(d => [d.qualification, d.toolsGenerated, d.toolsSubmitted, d.questionsAdded])
        ];
        const csv = rows.map(r => r.join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href     = url;
        a.download = 'assessor_reports.csv';
        a.click();
        URL.revokeObjectURL(url);
      });

      renderSummaries('');  // initial
    });
  </script>
</body>
</html>
