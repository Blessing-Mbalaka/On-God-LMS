{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Randomized Snapshot | {{ assessment.eisa_id }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f5f5f8; font-family: "Inter", system-ui, sans-serif; }
    .snapshot-header { display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap; }
    .snapshot-card { background:#fff; border-radius:12px; box-shadow:0 1px 6px rgba(15,23,42,0.08); padding:20px; margin-bottom:18px; }
    .snapshot-node { border:1px solid #e5e7eb; border-radius:8px; padding:14px 16px; margin-bottom:12px; background:#fff; }
    .snapshot-node__header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
    .snapshot-node__label { display:flex; align-items:center; flex-wrap:wrap; gap:.4rem; }
    .snapshot-node__type-badge { display:inline-flex; align-items:center; background:rgba(79,70,229,0.12); color:#312e81; font-size:0.75rem; font-weight:600; padding:2px 8px; border-radius:999px; text-transform:capitalize; }
    .snapshot-node__number { font-weight:700; color:#4b0082; font-size:0.95rem; }
    .snapshot-node__parent { font-size:0.85rem; color:#475569; }
    .snapshot-node__marks { font-size:0.85rem; color:#0f172a; background:rgba(79,70,229,0.08); border-radius:999px; padding:2px 10px; margin-left:8px; }
    .snapshot-node__text { margin-bottom:10px; color:#1f2937; white-space:pre-wrap; }
    .snapshot-node__children { border-left:2px solid rgba(79,70,229,0.25); margin-left:14px; padding-left:14px; }
    .snapshot-node__images { display:flex; flex-wrap:wrap; gap:8px; }
    .snapshot-node__controls { display:flex; align-items:flex-start; gap:.5rem; }
    .snapshot-node__actions { display:flex; flex-wrap:wrap; gap:.3rem; }
    .snapshot-node__actions form { display:inline; }
    .snapshot-node__image { max-width:100%; height:auto; border-radius:6px; border:1px solid #e5e7eb; }
    .snapshot-node--heading { background:#f0fdf4; border-left:3px solid #22c55e; }
    .snapshot-node--case_study { background:#fff7ed; border-left:3px solid #f97316; }
    .snapshot-node--instruction { background:#eef2ff; border-left:3px solid #6366f1; }
    .snapshot-node--cover_page { background:#f8fafc; border-left:3px solid #2563eb; }
    .snapshot-node__content p { margin-bottom:.5rem; }
    .snapshot-node__meta { display:inline-flex; align-items:center; gap:.35rem; background:rgba(99,102,241,0.18); color:#3730a3; font-size:0.72rem; font-weight:600; border-radius:999px; padding:2px 8px; }
    .badge-status { display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .65rem; border-radius:999px; font-weight:600; }
    .badge-status.info { background:rgba(59,130,246,0.12); color:#1d4ed8; }
    .badge-status.warning { background:rgba(250,204,21,0.18); color:#b45309; }
    .badge-status.success { background:rgba(34,197,94,0.15); color:#047857; }
    .badge-status.default { background:rgba(148,163,184,0.18); color:#475569; }
    .snapshot-select { max-width:320px; }
    .snapshot-actions { display:flex; flex-direction:column; align-items:flex-end; gap:.5rem; min-width:220px; }
    .snapshot-actions .btn { width:100%; }
    .snapshot-breadcrumb { display:flex; flex-wrap:wrap; gap:.5rem; margin-top:1rem; }
    .snapshot-breadcrumb span { background:rgba(79,70,229,0.1); color:#312e81; padding:4px 12px; border-radius:999px; font-size:0.78rem; font-weight:600; }
  </style>
</head>
<body>
  <div class="container my-4">
    {% if messages %}
      <div class="mb-3">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'info' }} mb-2">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
    {% if created_snapshot %}
      <div class="alert alert-success d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-2">
        <div>
          <strong>Snapshot saved.</strong> {{ created_snapshot_details.eisa|default:assessment.eisa_id }} is now available.
          <div class="small text-muted">Paper ID {{ created_snapshot_details.paper_id|default:paper.id }} | Marks {{ created_snapshot_details.marks|default:paper.total_marks|default:'0' }} | Pool size {{ created_snapshot_details.pool|default:random_meta.snapshot_pool_size|default:'0' }} | Total snapshots {{ snapshots_total }}</div>
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-sm btn-outline-success" href="{% url 'assessor_developer' %}">View all snapshots</a>
        </div>
      </div>
    {% endif %}
    <div class="mb-3">
      <a href="{% url 'assessor_developer' %}" class="text-decoration-none">&larr; Back to Assessor Developer</a>
    </div>

    <div class="snapshot-card">
      <div class="snapshot-header">
        <div>
          <h2 class="mb-1">Randomized Snapshot - {{ assessment.eisa_id }}</h2>
          <div class="text-muted">Qualification: {{ assessment.qualification.name|default:"Not linked" }}</div>
          {% if assessment.status %}
            {% with status=assessment.status %}
              {% if "ETQA" in status %}
                <span class="badge-status info mt-2">{{ status }}</span>
              {% elif "QCTO" in status %}
                <span class="badge-status warning mt-2">{{ status }}</span>
              {% elif "Approved" in status %}
                <span class="badge-status success mt-2">{{ status }}</span>
              {% else %}
                <span class="badge-status default mt-2">{{ status }}</span>
              {% endif %}
            {% endwith %}
          {% endif %}
        </div>
        <div class="snapshot-actions">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#snapshotModal">View Saved Snapshots</button>
          <small class="text-muted text-end">Snapshots are randomized reconstructions generated via captured content blocks.</small>
          <label for="snapshot-switch" class="form-label mb-0">Jump to snapshot</label>
          <select id="snapshot-switch" class="form-select form-select-sm">
            <option value="">Current snapshot</option>
            {% for snap in randomized_snapshots %}
              <option value="{% url 'assessor_randomized_snapshot' snap.id %}" {% if snap.id == assessment.id %}selected{% endif %}>
                {{ snap.eisa_id }} - {{ snap.paper }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="snapshot-breadcrumb">
        {% if base_paper %}
          <span>Base Paper: {{ base_paper.name }} (ID {{ base_paper.id }})</span>
        {% endif %}
        {% if paper %}
          <span>Snapshot Paper ID: {{ paper.id }}</span>
        {% endif %}
        {% if assessment.paper %}
          <span>Paper Title: {{ assessment.paper }}</span>
        {% endif %}
        {% if module_name_meta %}
          <span>Module: {{ module_name_meta }}</span>
        {% endif %}
        {% if module_number_meta %}
          <span>Paper Letter: {{ module_number_meta }}</span>
        {% elif paper.paper_letter %}
          <span>Paper Letter: {{ paper.paper_letter }}</span>
        {% endif %}
        {% if paper.paper_number %}
          <span>Paper Number: {{ paper.paper_number }}</span>
        {% endif %}
        <span>Snapshot Assessment ID: {{ current_snapshot_id }}</span>
        {% if assessment.eisa_id %}
          <span>EISA: {{ assessment.eisa_id }}</span>
        {% endif %}
      </div>

      <div class="row mt-3 g-3">
        <div class="col-md-8">
          <dl class="row mb-0">
            <dt class="col-sm-4">Paper name</dt>
            <dd class="col-sm-8">{{ assessment.paper }}</dd>
            <dt class="col-sm-4">Created</dt>
            <dd class="col-sm-8">{{ assessment.created_at|date:"M j, Y H:i" }}</dd>
            <dt class="col-sm-4">Total marks</dt>
            <dd class="col-sm-8">{{ paper.total_marks|default:"0" }}</dd>
            {% if qual_name_meta %}
              <dt class="col-sm-4">Qualification</dt>
              <dd class="col-sm-8">{{ qual_name_meta }}</dd>
            {% endif %}
            {% if base_paper %}
              <dt class="col-sm-4">Base paper origin</dt>
              <dd class="col-sm-8">{{ base_paper.name }} (ID {{ base_paper.id }})</dd>
            {% endif %}
            {% if random_meta.module_name or module_name_meta %}
              <dt class="col-sm-4">Module</dt>
              <dd class="col-sm-8">{{ random_meta.module_name|default:module_name_meta }}</dd>
            {% endif %}
            {% if random_meta.module_number or module_number_meta %}
              <dt class="col-sm-4">Paper letter</dt>
              <dd class="col-sm-8">{{ random_meta.module_number|default:module_number_meta }}</dd>
            {% endif %}
            {% if random_meta.status or random_status_label %}
              <dt class="col-sm-4">Randomization status</dt>
              <dd class="col-sm-8 text-capitalize">{{ random_meta.status|default:random_status_label }}</dd>
            {% endif %}
            {% if allowed_letters_display %}
              <dt class="col-sm-4">Available versions</dt>
              <dd class="col-sm-8">{{ allowed_letters_display }}</dd>
            {% endif %}
            {% if random_meta.cover_title or cover_heading_meta %}
              <dt class="col-sm-4">Cover title</dt>
              <dd class="col-sm-8">{{ random_meta.cover_title|default:cover_heading_meta }}</dd>
            {% endif %}
            {% if random_meta.source %}
              <dt class="col-sm-4">Source</dt>
              <dd class="col-sm-8 text-capitalize">{{ random_meta.source }}</dd>
            {% elif random_meta.snapshot_pool_used %}
              <dt class="col-sm-4">Source</dt>
              <dd class="col-sm-8">Snapshot pool ({{ random_meta.snapshot_pool_size|default:"0" }})</dd>
            {% endif %}
            {% if random_meta.snapshot_pool_size %}
              <dt class="col-sm-4">Pool size</dt>
              <dd class="col-sm-8">{{ random_meta.snapshot_pool_size }}</dd>
            {% endif %}
            {% if random_meta.last_refreshed %}
              <dt class="col-sm-4">Last refreshed</dt>
              <dd class="col-sm-8">{{ random_meta.last_refreshed }}</dd>
            {% endif %}
          </dl>
        </div>
        <div class="col-md-4">
          <div class="bg-light rounded-3 p-3 h-100">
            <div class="fw-semibold mb-2">Structure overview</div>
            <div>Questions: <strong>{{ node_stats.questions }}</strong></div>
            <div>Tables: <strong>{{ node_stats.tables }}</strong></div>
            <div>Images: <strong>{{ node_stats.images }}</strong></div>
            <div>Instructions: <strong>{{ node_stats.instructions }}</strong></div>
          </div>
        </div>
      </div>

      <form method="post" class="mt-3 d-flex flex-wrap gap-2">
        {% csrf_token %}
        <input type="hidden" name="refresh" value="0">
        {% if can_open_pipeline %}
          <button type="submit" name="action" value="open_pipeline" class="btn btn-sm btn-primary">Open in Advanced Pipeline</button>
          <button type="submit" name="action" value="open_pipeline" class="btn btn-sm btn-outline-secondary" onclick="this.form.refresh.value='1'">Rebuild &amp; Open</button>
        {% endif %}
        <button type="submit" name="action" value="forward_etqa" class="btn btn-sm btn-warning text-white">Forward ETQA</button>
        <button type="submit" name="action" value="forward_qcto" class="btn btn-sm btn-outline-warning">Forward QCTO</button>
        {% if assessment.status != 'Released to students' %}
          <button type="submit" name="action" value="release_students" class="btn btn-sm btn-success">Release to Learners</button>
        {% endif %}
        <div class="w-100 mt-2">
          <button type="submit" name="action" value="create_snapshot" class="btn btn-success btn-lg w-100">Save New Randomized Snapshot</button>
        </div>
        <div class="w-100 mt-2">
          <button type="submit" name="action" value="update_snapshot" class="btn btn-info btn-lg text-white w-100">Update Snapshot Structure</button>
        </div>
      </form>
    </div>


    {% if cover_nodes %}
      <div class="snapshot-card">
        <h4 class="mb-3">Cover &amp; Instructions</h4>
        {% if random_meta.cover_title|default:cover_heading_meta %}
          <div class="alert alert-secondary py-2 px-3 mb-3">{{ random_meta.cover_title|default:cover_heading_meta }}</div>
        {% endif %}
        {% for node in cover_nodes %}
          {% include 'core/assessor-developer/_snapshot_node.html' with node=node %}
        {% endfor %}
      </div>
    {% endif %}

    {% if question_nodes %}
      <div class="snapshot-card">
        <h4 class="mb-3">Questions</h4>
        {% for node in question_nodes %}
          {% include 'core/assessor-developer/_snapshot_node.html' with node=node %}
        {% endfor %}
      </div>
    {% elif paper %}
      <div class="snapshot-card">
        <h4 class="mb-3">Questions</h4>
        <p class="text-muted mb-0">No structured question nodes were saved for this paper.</p>
      </div>
    {% else %}
      <div class="snapshot-card">
        <h4 class="mb-3">Reconstructed Paper</h4>
        <p class="text-muted mb-0">This snapshot does not have an attached reconstructed paper yet.</p>
      </div>
    {% endif %}
  </div>

  <div class="modal fade" id="snapshotModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Saved Randomized Snapshots</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {% if randomized_snapshots %}
            <div class="list-group">
              {% for snap in randomized_snapshots %}
                <a href="{% url 'assessor_randomized_snapshot' snap.id %}" class="list-group-item list-group-item-action{% if snap.id == assessment.id %} active{% endif %}">
                  <div class="d-flex w-100 justify-content-between">
                    <span>{{ snap.eisa_id }} - {{ snap.paper }}</span>
                    <small>{{ snap.created_at|date:"M j, Y H:i" }}</small>
                  </div>
                  <small class="text-muted d-block">Module {{ snap.module_name|default:"-" }} {{ snap.module_number|default:"" }} | Paper ID {{ snap.paper_link.id }} | Status {{ snap.status }}</small>
                </a>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted mb-0">No randomized snapshots captured yet.</p>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.getElementById('snapshot-switch')?.addEventListener('change', function(){
      if (this.value && this.value !== window.location.href) {
        window.location.href = this.value;
      }
    });
  </script>
</body>
</html>
