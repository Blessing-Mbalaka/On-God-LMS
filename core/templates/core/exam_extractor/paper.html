
{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ paper.title }}</title>
  <style>
    /* Base */
    .paper-page { font-family: Inter, system-ui, sans-serif; margin: 0; background:#f6f8fa; color:#0f172a; }
    /* Fixed header toolbar with reserved space */
    .paper-page .toolbar { position: fixed; top: 0; left: 0; right: 0; background: #fff; border-bottom: 1px solid #eee; padding: .5rem 1rem; display:flex; gap:1rem; align-items:center; z-index: 250; box-shadow: 0 2px 8px rgba(0,0,0,.06); }
    .paper-page { padding-top: 58px; }
    .paper-page .btn { padding: .4rem .8rem; background: #111; color: #fff; text-decoration: none; border-radius: .4rem; }

    /* Layout */
    .paper-page .layout { display: grid; grid-template-columns: 1fr 340px; gap: 1rem; max-width: 1200px; margin: 1rem auto; padding: 0 1rem; }
    .paper-page #paper-container { position: relative; max-width: 100%; padding: 1rem; background:#ffffff; border:1px solid #e5e7eb; border-radius:.5rem; min-height: 60vh; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .paper-page .block { padding: .4rem .2rem; margin: .25rem 0; }
    .paper-page .block[data-type='rubric'] { background: #fff7ed; border-left: 3px solid #f59e0b; }
    .paper-page .block-image { max-width:100%; height:auto; display:block; margin:.3rem 0; }
    .paper-page #saved-overlay { position:absolute; left:0; top:0; right:0; bottom:0; pointer-events:none; z-index: 10; }
    .paper-page #lasso-overlay { position:absolute; left:0; top:0; right:0; bottom:0; pointer-events:none; z-index: 20; }
    .paper-page .selection-rect { position:absolute; border:2px dashed #2563eb; background: rgba(37,99,235,.08); border-radius:.25rem; box-shadow: 0 0 0 1px rgba(37,99,235,.25) inset; }
    .paper-page .saved-highlight { position:absolute; border:2px solid #f59e0b; background: rgba(245,158,11,.12); border-radius:.25rem; box-shadow: inset 0 0 0 1px rgba(245,158,11,.3); }

    /* Sidebar */
    .paper-page .sidebar { background:#fff; border:1px solid #e5e7eb; border-radius:.5rem; padding: .75rem; height: calc(100% - 2px); display:flex; flex-direction:column; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .paper-page .sidebar h3 { margin:.25rem 0 .5rem; font-size: 1.05rem; color:#1f2937; }
    .paper-page .sidebar form { display:grid; gap:.55rem; }
    .paper-page .sidebar form label { font-size:.82rem; font-weight:600; color:#475569; }
    .paper-page .sidebar form input,
    .paper-page .sidebar form select,
    .paper-page .sidebar form textarea { border:1px solid #d1d5db; border-radius:.45rem; padding:.5rem .6rem; font-size:.92rem; color:#0f172a; background:#fff; transition:border-color .2s ease, box-shadow .2s ease; width:100%; box-sizing:border-box; }
    .paper-page .sidebar form input::placeholder,
    .paper-page .sidebar form textarea::placeholder { color:#94a3b8; }
    .paper-page .sidebar form select:focus,
    .paper-page .sidebar form input:focus,
    .paper-page .sidebar form textarea:focus { outline:none; border-color:#6366f1; box-shadow:0 0 0 2px rgba(99,102,241,.15); }
    .paper-page .sidebar form .btn { background:#4f46e5; border:none; color:#fff; border-radius:.45rem; padding:.55rem 1.1rem; font-weight:600; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease; }
    .paper-page .sidebar form .btn:hover { transform:translateY(-1px); box-shadow:0 12px 20px -14px rgba(79,70,229,.5); }
    .paper-page .sidebar form select { appearance:none; background-image:url('data:image/svg+xml;utf8,<svg fill="none" stroke="%23343a40" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m6 9 6 6 6-6"/></svg>'); background-repeat:no-repeat; background-position:right .7rem center; background-size:1rem; padding-right:2rem; }
    .paper-page .sidebar .meta-grid { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:.55rem; }
    .paper-page .boxes { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:.5rem; overflow:auto; }

    /* Expandable items */
    .paper-page .box-item { border:1px solid #e5e7eb; border-radius:.5rem; background:#fafafa; font-size:.92rem; overflow: hidden; }
    .paper-page .box-item summary { list-style:none; cursor:pointer; padding:.55rem .6rem; display:flex; justify-content:space-between; align-items:center; gap:.5rem; }
    .paper-page .box-item[open] summary { background:#f3f4f6; }
    .paper-page .box-item .title { font-weight:600; }
    .paper-page .box-item .kv { color:#6b7280; font-size:.86rem; }
    .paper-page .box-meta { padding:.5rem .6rem .7rem; border-top:1px solid #e5e7eb; display:grid; gap:.35rem; }
    .paper-page .chev { color:#6b7280; font-size:.9rem; }
    .paper-page summary::-webkit-details-marker { display:none; }

    /* Icon buttons */
    .paper-page .actions { display:flex; gap:.4rem; align-items:center; }
    .paper-page .btn-icon { border:1px solid #d1d5db; background:#fff; color:#374151; border-radius:.35rem; padding:.2rem .45rem; cursor:pointer; font-size:.85rem; }
    .paper-page .btn-icon:hover { background:#f3f4f6; }

    /* Tables */
    .paper-page .docx-table { border-collapse: collapse; width: 100%; background:#fff; }
    .paper-page .docx-table td, .paper-page .docx-table th { border: 1px solid #e5e7eb; padding: 6px 8px; vertical-align: top; }

    /* Modal */
    .paper-page .modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,.25); z-index: 100; }
    .paper-page .modal.hidden { display:none; }
    .paper-page #meta-form { background:#fff; padding:1rem; border-radius:.6rem; min-width:320px; display:grid; gap:.6rem; box-shadow: 0 2px 8px rgba(0,0,0,.15); }
    .paper-page #meta-form input, .paper-page #meta-form select { width:100%; }
    .paper-page #meta-form .conditional-field { display:none; }
    .paper-page .modal-actions { display:flex; gap:.5rem; justify-content:flex-end; }

    /* Preview modal */
    .paper-page #preview-modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.5); z-index:50; }
    .paper-page #preview-modal.open { display:flex; }
    /* Make snapshot modal fill more of the screen */
    .paper-page .preview-card { background:#fff; border-radius:.6rem; width:min(95vw, 1200px); max-height:90vh; display:flex; flex-direction:column; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    .paper-page .preview-header { display:flex; justify-content:space-between; align-items:center; padding:.6rem .8rem; border-bottom:1px solid #e5e7eb; }
    .paper-page .preview-body { padding:.6rem; }
    /* Larger viewport for snapshot preview */
    .paper-page #preview-viewport { width: 90vw; max-width: 1200px; height: 80vh; border:1px solid #e5e7eb; border-radius:.4rem; overflow:hidden; background:#fff; }
    .paper-page #preview-scene { transform-origin: 0 0; }
    .paper-page .preview-actions { padding:.6rem .8rem; display:flex; justify-content:flex-end; gap:.5rem; border-top:1px solid #e5e7eb; }
    /* Question headers UI */
    .q-header { margin: .8rem 0 .4rem; padding:.35rem .5rem; background:#eef2ff; border:1px solid #e0e7ff; color:#1e3a8a; font-weight:600; border-radius:.4rem; }
      .paper-page #content-body .docx-table { border-collapse: collapse; width: 100%; background:#fff; }
    .paper-page #content-body .docx-table td, .paper-page #content-body .docx-table th { border: 1px solid #e5e7eb; padding: 6px 8px; vertical-align: top; }
  </style>
  {% now 'U' as ts %}
  <script defer src="{% static 'core/exam_extractor/lasso.js' %}?v={{ ts }}"></script>
</head>
<body class="paper-page">
  <div class="toolbar">
    <a href="{% url dashboard_url %}">&larr; Back to {{ dashboard_display_name }}</a>
    <button type="button" class="btn" id="btn-ai-draw" data-api="{% url 'exam_ai_draw_blocks' paper.id %}">Draw
      Blocks</button>
    <form id="mbalaka-classify-form" method="post" action="{% url 'exam_mbalaka_classify' paper.id %}"
      style="display:inline-block; margin:0;">
      {% csrf_token %}
    </form>
  </div>
    
  </div>

  <div class="layout">
    <div id="paper-container">
      {% for b in blocks %}
        {% if b.is_qheader %}
          <div class="q-header">Question {{ b.detected_qnum }}{% if b.detected_marks %} ({{ b.detected_marks }} marks){% endif %}</div>
        {% endif %}
        <div class="block" data-id="{{ b.id }}" data-type="{{ b.block_type }}">
          {% if b.block_type == 'image' and b.images.all %}
            {% for img in b.images.all %}
              <img src="{{ img.image.url }}" class="block-image" alt="image {{forloop.counter}}"/>
            {% endfor %}
          {% elif b.block_type == 'table' %}
            <div class="block-table">
              {{ b.text|safe }}
            </div>
          {% else %}
            <div class="block-text">
              {{ b.text|linebreaksbr }}
            </div>
            {% if b.images.all %}
              {% for img in b.images.all %}
                <img src="{{ img.image.url }}" class="block-image" alt="image {{forloop.counter}}"/>
              {% endfor %}
            {% endif %}
          {% endif %}
        </div>
      {% endfor %}

      <!-- Selection overlay lives here -->
      <div id="lasso-overlay"></div>
      <!-- Saved highlights (question_header boxes) -->
      <div id="saved-overlay"></div>
    </div>

    <aside class="sidebar">
      <h3>Paper Meta</h3>
      <form id="paper-meta-form" method="post" action="{% url 'exam_save_paper_meta' paper.id %}" style="margin-bottom:1rem;">
        {% csrf_token %}
        <label>Module Name</label>
        <select name="module_name" required>
          <option value="">Select qualification…</option>
          {% for qual in qualifications %}
            <option value="{{ qual.name }}" {% if paper.module_name == qual.name %}selected{% endif %}>{{ qual.name }}</option>
          {% endfor %}
        </select>
        <div class="meta-grid">
          <div>
            <label>Set Number</label>
            <select name="paper_number" id="paper-number" data-current="{{ paper.paper_number }}">
              <option value="">Select number</option>
            </select>
          </div>
          <div>
            <label>Set Letter</label>
            <select name="paper_letter" id="paper-letter" data-current="{{ paper.paper_letter }}">
              <option value="">Select letter</option>
            </select>
          </div>
        </div>
        <input type="hidden" name="title" id="paper-title" value="{{ paper.title }}" />
        <div style="display:flex; justify-content:flex-end;">
          <button type="submit" class="btn">Save Meta</button>
        </div>
      </form>
      <h3 style="display:none;">AI Settings</h3>
      <form method="post" action="{% url 'exam_save_system_prompt' paper.id %}" style="display:none;">
        {% csrf_token %}
        <textarea name="system_prompt" rows="5" placeholder="System prompt per paper..." style="width:100%; padding:.4rem;">{{ paper.system_prompt }}</textarea>
        <div style="display:flex; justify-content:flex-end;">
          <button type="submit" class="btn">Save Prompt</button>
        </div>
      </form>
      <h3>Saved Boxes</h3>
      <ul id="boxes-list" class="boxes">
        {% for bx in boxes %}
          <details class="box-item"
                   data-id="{{ bx.id }}"
                   data-x="{{ bx.x }}"
                   data-y="{{ bx.y }}"
                   data-w="{{ bx.w }}"
                   data-h="{{ bx.h }}"
                   data-qn="{{ bx.question_number|default:'' }}"
                   data-parent-number="{{ bx.parent_number|default:'' }}"
                   data-header-label="{{ bx.header_label|default:'' }}"
                   data-case-label="{{ bx.case_study_label|default:'' }}"
                   data-marks="{{ bx.marks|default:'' }}"
                   data-qtype="{{ bx.qtype|default:'' }}"
                   data-update-url="{% url 'exam_update_box' paper.id bx.id %}"
                   data-delete-url="{% url 'exam_delete_box' paper.id bx.id %}"
                   data-json-url="{% url 'exam_get_box' paper.id bx.id %}"
                   data-ctype="{{ bx.content_type }}"
                   data-content="{{ bx.content|default:''|escapejs }}"
                   data-created-at="{{ bx.created_at|date:'c' }}">
            <summary>
              <span class="title">{{ bx.display_qtype }}</span>
              <span class="kv">
                Q: {{ bx.question_number|default:"n/a" }}
                {% if bx.parent_number %}&bull; Parent: {{ bx.parent_number }}{% endif %}
                &bull; Marks: {{ bx.marks|default:"n/a" }}
              </span>
              <span class="actions">
                <button type="button" class="btn-icon view-content" title="View captured content" aria-label="View content">Content</button>
                <button type="button" class="btn-icon view-snapshot" title="View snapshot" aria-label="View snapshot">Snap</button>
                <button type="button" class="btn-icon edit-box" title="Edit this box" aria-label="Edit">Edit</button>
                <button type="button" class="btn-icon resize-box" title="Resize this box" aria-label="Resize">Resize</button>
                <button type="button" class="btn-icon delete-box" title="Delete this box" aria-label="Delete">Delete</button>
                <span class="chev">?</span>
              </span>
            </summary>
            <div class="box-meta">
              <div class="kv">x={{ bx.x|floatformat:0 }}, y={{ bx.y|floatformat:0 }}, w={{ bx.w|floatformat:0 }}, h={{ bx.h|floatformat:0 }}</div>
              {% if bx.parent_number %}<div class="kv">Parent: {{ bx.parent_number }}</div>{% endif %}
              {% if bx.header_label %}<div class="kv">Header: {{ bx.header_label }}</div>{% endif %}
              {% if bx.case_study_label %}<div class="kv">Case study: {{ bx.case_study_label }}</div>{% endif %}
              <div class="kv">{{ bx.created_at|date:"M j, Y, H:i" }}</div>
            </div>
          </details>
        {% empty %}
          <li class="box-item">No boxes yet. Draw a rectangle on the page to add one.</li>
        {% endfor %}
      </ul>
    </aside>
  </div>

  <!-- Save modal -->
  <div id="meta-modal" class="modal hidden">
    <form id="meta-form" method="post" action="{% url 'exam_create_box' paper.id %}">
      {% csrf_token %}
      <input type="hidden" name="x" />
      <input type="hidden" name="y" />
      <input type="hidden" name="w" />
      <input type="hidden" name="h" />
      <input type="hidden" name="content_json" />
      <input type="hidden" name="content_type" />
      <label for="question_number">Question #</label>
      <input id="question_number" name="question_number" placeholder="e.g., 1.1" required />

      <label for="marks">Marks</label>
      <input id="marks" name="marks" placeholder="e.g., 10" required />

      <label for="qtype">Type</label>
      <select id="qtype" name="qtype" title="Select type">
          <option value="question" selected>Question</option>
          <option value="question_part">Question Part</option>
          <option value="heading">Heading</option>
          <option value="case_study">Case Study</option>
          <option value="instruction">Instruction</option>
          <option value="cover_page">Cover Page</option>
      </select>

      <label for="parent_number">Parent #</label>
      <input id="parent_number" name="parent_number" placeholder="e.g., 1.1" />

      <label for="header_label" class="conditional-field" data-visible="heading">Header title</label>
      <input id="header_label" name="header_label" placeholder="Heading text" class="conditional-field" data-visible="heading" />

      <label for="case_study_label" class="conditional-field" data-visible="case_study">Case study title</label>
      <input id="case_study_label" name="case_study_label" placeholder="Case study title" class="conditional-field" data-visible="case_study" />
      <div class="modal-actions">
        <button type="submit">Save Box</button>
        <button type="button" id="cancel-meta" aria-label="Close metadata dialog">Cancel</button>
      </div>
    </form>
  </div>

  <!-- Snapshot Preview Modal -->
  <div id="preview-modal" class="modal">
    <div class="preview-card" role="dialog" aria-modal="true" aria-labelledby="preview-title">
      <div class="preview-header">
        <strong id="preview-title">Snapshot Preview</strong>
        <button type="button" class="btn-icon" id="preview-close" aria-label="Close">?</button>
      </div>
      <div class="preview-body">
        <div id="preview-viewport">
          <div id="preview-scene"></div>
        </div>
      </div>
      <div class="preview-actions">
        <button type="button" class="btn-icon" id="preview-zoom-out" title="Zoom out">-</button>
        <button type="button" class="btn-icon" id="preview-zoom-in" title="Zoom in">+</button>
      </div>
    </div>
  </div>

  <!-- Captured Content Modal -->
  <div id="content-modal" class="modal hidden">
    <div class="preview-card" role="dialog" aria-modal="true" aria-labelledby="content-title">
      <div class="preview-header">
        <strong id="content-title">Captured Content</strong>
        <span><button type="button" class="btn-icon" id="content-edit" title="Edit this box" aria-label="Edit">Edit</button> <button type="button" class="btn-icon" id="content-delete" title="Delete this box" aria-label="Delete">Delete</button> <button type="button" class="btn-icon" id="content-close" aria-label="Close">?</button></span>
      </div>
      <div class="preview-body" id="content-body"></div>
      <div class="preview-actions">
        <button type="button" class="btn-icon" id="content-ok">Close</button>
      </div>
    </div>
  </div>

  <!-- Question Bank Modal -->
  <div id="bank-modal" class="modal hidden">
    <div class="preview-card" role="dialog" aria-modal="true" aria-labelledby="bank-title">
      <div class="preview-header">
        <strong id="bank-title">Question Bank</strong>
        <button type="button" class="btn-icon" id="bank-close" aria-label="Close">?</button>
      </div>
      <div class="preview-body">
        <div style="display:grid; gap:.5rem;">
          <label for="bank-module">Module</label>
          <select id="bank-module"></select>
          <div id="bank-counts" style="font-size:.9rem; color:#374151;"></div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap: .75rem; margin-top:.5rem;">
            <div>
              <strong>Base (this paper)</strong>
              <div id="bank-base" class="boxes" style="border:1px solid #e5e7eb; border-radius:.4rem; padding:.5rem; max-height:250px; overflow:auto;"></div>
            </div>
            <div>
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <strong>Preview (randomized)</strong>
                <button type="button" class="btn-icon" id="bank-regenerate">Regenerate</button>
              </div>
              <div id="bank-preview" class="boxes" style="border:1px solid #e5e7eb; border-radius:.4rem; padding:.5rem; max-height:250px; overflow:auto;"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="preview-actions">
        <button type="button" class="btn-icon" id="bank-build">Build Randomized Test</button>
      </div>
    </div>
  </div>
  <script>
    (function(){
      const btn = document.getElementById('btn-bank');
      const modal = document.getElementById('bank-modal');
      const sel = document.getElementById('bank-module');
      const countsDiv = document.getElementById('bank-counts');
      const infoUrl = btn?.getAttribute('data-info');
      const previewUrl = '{% url "exam_bank_preview" paper.id %}';
      const randUrl = btn?.getAttribute('data-rand');
      const close = document.getElementById('bank-close');
      const baseDiv = document.getElementById('bank-base');
      const prevDiv = document.getElementById('bank-preview');
      const regenBtn = document.getElementById('bank-regenerate');
      function open(){ modal.classList.remove('hidden'); }
      function closeM(){ modal.classList.add('hidden'); }
      function renderContent(el, payload){
        el.innerHTML = '';
        (payload.items || []).forEach(item => {
          if (item.type === 'text') { const p = document.createElement('p'); p.textContent = item.text||''; el.appendChild(p); }
          else if (item.type === 'table') { const d = document.createElement('div'); d.innerHTML = item.html||''; el.appendChild(d); }
          else if (item.type === 'image') { (item.images||[]).forEach(src => { const i=document.createElement('img'); i.src=src; i.className='block-image'; el.appendChild(i); }); }
        });
      }
      function card(title, sub, payload){
        const wrap = document.createElement('div');
        wrap.style.border='1px solid #e5e7eb'; wrap.style.borderRadius='.35rem'; wrap.style.padding='.4rem .5rem'; wrap.style.margin='.35rem 0';
        const h = document.createElement('div'); h.innerHTML = `<strong>${title}</strong> <span style="color:#6b7280; font-size:.85rem;">${sub||''}</span>`; wrap.appendChild(h);
        const body = document.createElement('div'); wrap.appendChild(body);
        try { renderContent(body, payload); } catch(_) {}
        return wrap;
      }
      async function loadModules(){
        const r = await fetch(infoUrl, { credentials:'same-origin' });
        const j = await r.json();
        sel.innerHTML='';
        (j.modules||[]).forEach(m => { const o=document.createElement('option'); o.value=m; o.textContent=m; sel.appendChild(o); });
        // render base list
        baseDiv.innerHTML = '';
        (j.base||[]).forEach(b => {
          let payload = {};
          try { payload = JSON.parse(b.content||'{}'); } catch(_) {}
          baseDiv.appendChild(card(`Q ${b.question_number}`, b.marks ? `(${b.marks} marks)` : '', payload));
        });
        if (sel.value) { loadCounts(sel.value); await regenerate(); }
      }
      async function loadCounts(mod){
        const u = infoUrl + `?module=${encodeURIComponent(mod)}`;
        const r = await fetch(u, { credentials:'same-origin' });
        const j = await r.json();
        const entries = Object.entries(j.counts||{}).sort((a,b)=> a[0].localeCompare(b[0]));
        countsDiv.innerHTML = entries.map(([q,c])=>`${q||'(blank)'}: ${c}`).join(' · ');
      }
      async function regenerate(){
        prevDiv.innerHTML = '';
        const u = previewUrl + `?module_name=${encodeURIComponent(sel.value)}`;
        const r = await fetch(u, { credentials:'same-origin' });
        const j = await r.json();
        (j.items||[]).forEach(b => {
          let payload = {};
          try { payload = JSON.parse(b.content||'{}'); } catch(_) {}
          const el = card(`Q ${b.question_number}`, b.marks ? `(${b.marks} marks)` : '', payload);
          el.dataset.boxId = String(b.box_id);
          prevDiv.appendChild(el);
        });
      }
      sel?.addEventListener('change', ()=> loadCounts(sel.value));
      btn?.addEventListener('click', ()=> { open(); loadModules(); });
      close?.addEventListener('click', closeM);
      regenBtn?.addEventListener('click', regenerate);
      document.getElementById('bank-build')?.addEventListener('click', async ()=>{
        if (!sel.value) return alert('Select a module');
        const fd = new FormData();
        fd.append('module_name', sel.value);
        // include previewed picks (if present) to persist exactly what is shown
        const ids = Array.from(prevDiv.querySelectorAll('[data-box-id]')).map(n => n.dataset.boxId).filter(Boolean);
        if (ids.length) fd.append('box_ids', ids.join(','));
        const csrf = document.querySelector('input[name=csrfmiddlewaretoken]')?.value;
        const r = await fetch(randUrl, { method:'POST', body: fd, credentials:'same-origin', headers: csrf ? { 'X-CSRFToken': csrf } : {} });
        if (!r.ok) return alert('Failed to build test');
        const j = await r.json();
        if (j && (j.test_url || j.test_id)){
          window.location.href = j.test_url || (`/test/${j.test_id}/`);
        }
      });
    })();
  </script>
<script type="application/json" id="module-catalog">{{ module_catalog_json|safe }}</script>
<script>
  (function () {
    const catalogEl = document.getElementById('module-catalog');
    const metaForm = document.querySelector('form[action="{% url 'exam_save_paper_meta' paper.id %}"]');
    if (!catalogEl || !metaForm) {
      return;
    }

    const moduleSelect = metaForm.querySelector('select[name="module_name"]');
    const numberSelect = metaForm.querySelector('select[name="paper_number"]');
    const letterSelect = metaForm.querySelector('select[name="paper_letter"]');
    const titleInput = metaForm.querySelector('input[name="title"]');

    if (!moduleSelect || !numberSelect || !letterSelect || !titleInput) {
      return;
    }

    let catalog = {};
    try {
      catalog = JSON.parse(catalogEl.textContent || '{}');
    } catch (err) {
      console.warn('Unable to parse module catalog', err);
      catalog = {};
    }

    const normalize = (value) => (value ?? '').toString().trim();
    const parseCode = (code) => {
      const normalized = normalize(code);
      if (!normalized) {
        return { number: '', suffix: '' };
      }
      const match = normalized.match(/^(\d+)(.*)$/);
      return {
        number: match ? match[1] : '',
        suffix: match ? normalize(match[2]) : '',
      };
    };

    const defaultPaperNumbers = Array.from({ length: 20 }, (_, idx) => String(idx + 1));

    const allModules = Object.values(catalog).reduce((acc, entry) => {
      if (Array.isArray(entry)) {
        entry.forEach(mod => acc.push(mod));
      }
      return acc;
    }, []);

    const initialNumber = normalize(numberSelect.dataset.current || numberSelect.value);
    const initialLetter = normalize(letterSelect.dataset.current || letterSelect.value);

    const modulesForSelection = () => {
      const selectedName = normalize(moduleSelect.value);
      const scoped = catalog[selectedName];
      if (Array.isArray(scoped) && scoped.length) {
        return scoped;
      }
      return allModules;
    };

    const rebuildNumberOptions = () => {
      const previous = normalize(numberSelect.value) || initialNumber;
      const modules = modulesForSelection();
      const set = new Map();
      modules.forEach(mod => {
        const numberPart = parseCode(mod.code).number;
        if (numberPart) {
          set.set(numberPart, true);
        }
      });
      if (initialNumber && !set.has(initialNumber)) {
        set.set(initialNumber, true);
      }
      if (!set.size) {
        defaultPaperNumbers.forEach(num => set.set(num, true));
      }
      const ordered = Array.from(set.keys())
        .filter(Boolean)
        .sort((a, b) => (Number(a) - Number(b)) || a.localeCompare(b));

      numberSelect.innerHTML = '<option value="">Select number</option>';
      ordered.forEach(num => {
        const opt = document.createElement('option');
        opt.value = num;
        opt.textContent = num;
        if (previous && previous === num) {
          opt.selected = true;
        }
        numberSelect.appendChild(opt);
      });
      if (!numberSelect.value && ordered.length === 1) {
        numberSelect.value = ordered[0];
      }
    };

    const rebuildLetterOptions = () => {
      const previous = normalize(letterSelect.value) || initialLetter;
      const selectedNumber = normalize(numberSelect.value) || initialNumber;
      const modules = modulesForSelection().filter(mod => {
        if (!selectedNumber) {
          return true;
        }
        return parseCode(mod.code).number === selectedNumber;
      });

      const entries = new Map();
      modules.forEach(mod => {
        const code = normalize(mod.code);
        if (!code) {
          return;
        }
        const parts = parseCode(code);
        const suffix = parts.suffix || code.replace(/^[0-9]+/, '') || code;
        entries.set(code, suffix);
      });
      if (initialLetter && !entries.has(initialLetter)) {
        const parts = parseCode(initialLetter);
        const suffix = parts.suffix || initialLetter.replace(/^[0-9]+/, '') || initialLetter;
        entries.set(initialLetter, suffix);
      }

      const defaultLetters = ['A', 'B', 'C', 'D'];
      if (selectedNumber) {
        defaultLetters.forEach(letter => {
          const code = `${selectedNumber}${letter}`;
          if (!entries.has(code)) {
            entries.set(code, letter);
          }
        });
      } else {
        defaultLetters.forEach(letter => {
          if (!entries.has(letter)) {
            entries.set(letter, letter);
          }
        });
      }

      letterSelect.innerHTML = '<option value="">Select letter</option>';
      entries.forEach((label, code) => {
        const opt = document.createElement('option');
        opt.dataset.code = code;
        opt.value = label || code;
        opt.textContent = label || code;
        if (previous && (previous === code || previous === opt.value)) {
          opt.selected = true;
        }
        letterSelect.appendChild(opt);
      });

      if (!letterSelect.value && letterSelect.options.length === 2) {
        letterSelect.selectedIndex = 1;
      }
    };

    const computeTitle = () => {
      const moduleText = normalize(moduleSelect.options[moduleSelect.selectedIndex]?.text || moduleSelect.value);
      const numberValue = normalize(numberSelect.value);
      const letterValue = normalize(letterSelect.value);
      const selectedLetterOption = letterSelect.options[letterSelect.selectedIndex];
      const letterCodeFull = normalize(selectedLetterOption?.dataset.code || (numberValue ? `${numberValue}${letterValue}` : letterValue));

      let suffix = '';
      if (numberValue || letterCodeFull) {
        const parts = parseCode(letterCodeFull);
        const letterSuffix = parts.suffix || (letterCodeFull.replace(new RegExp(`^${numberValue}`), '') || letterValue || '');
        suffix = `${numberValue}${letterSuffix}`.trim();
      }

      const segments = [];
      if (moduleText) {
        segments.push(moduleText);
      }
      if (suffix) {
        segments.push(suffix);
      }

      titleInput.value = segments.join(' ').trim();
    };

    rebuildNumberOptions();
    rebuildLetterOptions();
    computeTitle();

    moduleSelect.addEventListener('change', () => {
      rebuildNumberOptions();
      rebuildLetterOptions();
      computeTitle();
    });
    numberSelect.addEventListener('change', () => {
      rebuildLetterOptions();
      computeTitle();
    });
    letterSelect.addEventListener('change', computeTitle);
  })();
</script>

</body>
</html>