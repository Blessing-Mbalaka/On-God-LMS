{% extends "core/base.html" %}
{% load static %}

{% block content %}

<div class="overal_container">
  <div class="dashboard-container">
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="graduate-icon">
          <img src="{% static 'core/images/logo_simplebbbbbbbbbbbbbb.png' %}" alt="CHIETA Logo" style="width: 130px;">
        </div>
      </div>

      <nav class="sidebar-nav">
        <ul class="nav-list">


          <li class="nav-item">
            <a href="{% url 'admin_dashboard' %}"
              class="nav-link{% if request.resolver_match.url_name == 'admin_dashboard' %} active{% endif %}">
              <i class="fa fa-home"></i>
              <span>Dashboard</span>
            </a>
          </li>

          <li class="nav-item">
            <a class="nav-link{% if request.resolver_match.url_name == 'upload_assessment' %} active{% endif %}"
              href="{% url 'upload_assessment' %}">
              <i class="fa fa-upload"></i>
              <span>Upload Assessment</span>
            </a>
          </li>

          <li class="nav-item">
            <a href="{% url 'assessment_centres' %}"
              class="nav-link{% if request.resolver_match.url_name == 'assessment_centres' %} active{% endif %}">
              <i class="fa fa-upload"></i>
              <span>Assessment Centres</span>
            </a>
          </li>

          <li class="nav-item">
            <a href="{% url 'review_saved_selector' %}"
              class="nav-link{% if request.resolver_match.url_name == 'review_saved_selector' %} active{% endif %}">
              <i class="fa fa-book"></i>
              <span>Question Bank</span>
            </a>
          </li>

          <li class="nav-item">
            <a href="{% url 'user_management' %}"
              class="nav-link{% if request.resolver_match.url_name == 'user_management' %} active{% endif %}">
              <i class="fa fa-cogs"></i>
              <span>User Management</span>
            </a>
          </li>

          <li class="nav-item">
            <a href="{% url 'manage_qualifications' %}"
              class="nav-link{% if request.resolver_match.url_name == 'manage_qualifications' %} active{% endif %}">
              <i class="fa fa-cogs"></i>
              <span>Qualifications</span>
            </a>
          </li>
        </ul>

        <div class="sidebar-footer">
          <a href="{% url 'logout' %}" class="logout-btn">
            <i class="fa fa-sign-out"></i>
            <span>Log Out</span>
          </a>
          <img src="{% static 'core/images/rb_2149331949.png' %}" alt="Sidebar Art" class="sidebar-art">
        </div>
      </nav>
    </div>

    <div class="container mt-5">
      <h2>Select a Saved Paper</h2>

      <!-- Filter by paper type -->
      <form method="get" class="mb-4">
        <label for="type" class="form-label">Filter by Type:</label>
        <select name="type" id="type" onchange="this.form.submit()" class="form-select w-auto d-inline-block ms-2">
          <option value="">All Papers</option>
          <option value="original" {% if filter_type=='original' %}selected{% endif %}>Original</option>
          <option value="randomized" {% if filter_type=='randomized' %}selected{% endif %}>Randomized</option>
        </select>
      </form>

      <!-- Paper selector -->
      <form method="post">
        {% csrf_token %}
        <div class="row g-2">
          <div class="col-sm-8">
            <select name="paper_id" id="paper-select" class="form-select">
              <label for="paper-select" class="form-label">Select a Paper to Load or Randomize:</label>

              <option value="">-- Choose a Paper --</option>
              {% for paper in papers %}
              <option value="{{ paper.pk }}">
                {{ paper.name }}
                {% if paper.is_randomized %}
                [RANDOMIZED]
                {% endif %}
                ‚Äì {{ paper.qualification.code|default:"No Code" }} (ID: {{ paper.pk }})
              </option>
              {% endfor %}
            </select>
          </div>



          <div class="col-sm-4 d-grid gap-2">
            <button type="submit" class="btn btn-primary mb-2">Load Paper</button>
            {% if papers %}
            <button type="button" class="btn btn-warning" id="randomize-btn">
              üîÅ Randomize Selected Paper
            </button>
            {% endif %}
          </div>
      </form>


      <hr class="my-5">
      <h4>üìÑ All Original Papers</h4>
      {% if original_papers %}
      <table class="table table-bordered table-striped table-sm">
        <thead>
          <tr>
            <th>Name</th>
            <th>Qualification</th>
            <th>Total Marks</th>
            <th>ID</th>
            <th>Created At</th>
            <th>Action</th>

          </tr>
        </thead>
        <tbody>
          {% for paper in original_papers %}
          <tr>
            <td>{{ paper.name }}</td>
            <td>{{ paper.qualification.name|default:"‚Äî" }}</td>
            <td>{{ paper.total_marks }}</td>
            <td>{{ paper.id }}</td>

            <td>{{ paper.created_at|date:"Y-m-d H:i" }}</td>
            <td>
              <a href="{% url 'load_saved_paper' paper.pk %}" class="btn btn-sm btn-outline-primary">
                View and update
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-muted">No original papers yet.</p>
      {% endif %}

      <hr class="my-5">

      <h4>üåÄ Randomized Papers</h4>
      {% if randomized_papers %}
      <table class="table table-bordered table-striped table-sm">
        <thead>
          <tr>
            <th>Name</th>
            <th>Qualification</th>
            <th>Total Marks</th>
            <th>ID</th>
            <th>Action</th>
            <th>Created At</th>
          </tr>
        </thead>
        <tbody>
          {% for paper in randomized_papers %}
          <tr>
            <td>{{ paper.name }}</td>
            <td>{{ paper.qualification.name|default:"‚Äî" }}</td>
            <td>{{ paper.total_marks }}</td>
            <td>{{ paper.id }}</td>
            <td>
              <a href="{% url 'load_saved_paper' paper.pk %}" class="btn btn-sm btn-outline-primary">
                View or update
              </a>
            </td>
            <td>{{ paper.created_at|date:"Y-m-d H:i" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-muted">No randomized papers yet.</p>
      {% endif %}

      {% endblock %}


      {% block extra_js %}
      <script>
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";").map(c => c.trim());
            for (const cookie of cookies) {
              if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }

        document.addEventListener('DOMContentLoaded', () => {
          const blocks = Array.from(document.querySelectorAll('.block'));
          const mapByQn = {};
          const parents = {};
          const childrenCount = {};

          // Map question numbers to DOM blocks
          blocks.forEach(b => {
            const qn = b.dataset.qn;
            if (qn) mapByQn[qn] = b;
          });

          // Build parent-child structure
          blocks.forEach(b => {
            if (b.dataset.type !== 'question') return;
            const parts = (b.dataset.qn || "").split('.');
            if (parts.length < 2) return;

            const parentKey = parts.slice(0, -1).join('.');
            const parentEl = mapByQn[parentKey];
            if (!parentEl) return;

            parents[b.dataset.id] = parentEl.dataset.id;
            childrenCount[parentEl.dataset.id] = (childrenCount[parentEl.dataset.id] || 0) + 1;

            let wrap = parentEl.querySelector('.children');
            if (!wrap) {
              wrap = document.createElement('div');
              wrap.className = 'children ms-4 mt-2';
              parentEl.appendChild(wrap);
            }

            wrap.appendChild(b);
          });

          // Add "Parent of X" and "Child of Y" badges
          blocks.forEach(b => {
            const id = b.dataset.id;
            const header = b.querySelector('.d-flex') || b;
            let badge = null;

            if (childrenCount[id]) {
              badge = document.createElement('span');
              badge.textContent = `Parent of ${childrenCount[id]}`;
              badge.className = 'badge bg-primary text-white ms-2';
            } else if (parents[id]) {
              const pEl = document.querySelector(`.block[data-id="${parents[id]}"]`);
              const pQn = pEl?.dataset.qn || '';
              badge = document.createElement('span');
              badge.textContent = `Child of ${pQn}`;
              badge.className = 'badge bg-secondary text-white ms-2';
            }

            if (badge) header.appendChild(badge);
          });

          // Serialize all blocks on form submit
          const form = document.getElementById('blocks-form');
          if (form) {
            form.addEventListener('submit', () => {
              const blocksData = Array.from(document.querySelectorAll('.block')).map(b => {
                const type = b.dataset.type || '';
                const id = b.dataset.id;
                const text = b.querySelector('.block-text')?.value?.trim()
                  || b.querySelector('.block-text')?.textContent?.trim()
                  || '';

                const content = Array.from(b.querySelectorAll('.block-content')).map(el => {
                  if (el.tagName === 'IMG') {
                    return { type: 'figure', data_uri: el.src };
                  }
                  if (el.tagName === 'TABLE') {
                    const rows = Array.from(el.querySelectorAll('tr')).map(row =>
                      Array.from(row.querySelectorAll('td')).map(cell => cell.innerText.trim())
                    );
                    return { type: 'table', rows };
                  }
                  if (el.closest('.border.bg-light')) {
                    return { type: 'case_study', text: el.innerText.trim() };
                  }
                  return { type: 'question_text', text: el.innerText.trim() };
                });

                return {
                  id,
                  number: b.dataset.qn || '',
                  type,
                  marks: b.dataset.marks || '',
                  parent_id: parents[id] || null,
                  text,
                  content,
                  ...(type === 'figure' ? { data_uri: b.querySelector('img')?.src || '' } : {})
                };
              });

              const outputField = document.getElementById('nodes-json');
              if (outputField) {
                outputField.value = JSON.stringify(blocksData);
              }
            });
          }

          // Optional: handle delete-block buttons
          document.querySelectorAll('.delete-block-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const block = btn.closest('.block');
              const hasChildren = block.querySelector('.children');
              if (hasChildren) {
                const confirmed = confirm('This block has child questions. Delete all?');
                if (!confirmed) return;
                hasChildren.remove();
              }
              block.remove();
            });
          });

          // Auto-Classify with AI button
          document.getElementById('ai-classify-btn').addEventListener('click', () => {
            const blocks = Array.from(document.querySelectorAll('.block')).map(b => {
              return {
                id: b.dataset.id,
                text: b.querySelector('.block-text')?.value?.trim() || b.querySelector('.block-text')?.textContent?.trim() || '',
                type: b.dataset.type || 'paragraph'
              };
            });

            const paperPk = window.location.pathname.match(/\/review-paper\/(\d+)\//)?.[1];
            if (!paperPk) {
              alert("‚ùå Error: paper ID not found in URL.");
              return;
            }

            fetch(`/administrator/review-paper/${paperPk}/classify/`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
              },
              body: JSON.stringify({ blocks })
            })
              .then(res => res.json())
              .then(data => {
                if (data.error) throw new Error(data.error);
                const types = data.types;
                if (!Array.isArray(types)) throw new Error("Response format invalid");

                // Update DOM with new types
                document.querySelectorAll('.block').forEach((b, i) => {
                  b.dataset.type = types[i] || 'paragraph';
                  const badge = b.querySelector('.type-badge');
                  if (badge) badge.textContent = types[i];
                });

                alert("‚úÖ Classification updated.");
              })
              .catch(err => {
                console.error(err);
                alert("‚ùå Classification failed.");
              });
          });
        });
      </script>
      {% endblock %}