{% load exam_extras %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Write Assessment · {{ assessment.paper }}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      color-scheme: light;
      --overlay-bg: rgba(255, 255, 204, 0.35);
      --overlay-border: rgba(234, 179, 8, 0.6);
      --overlay-focus: rgba(147, 112, 219, 0.55);
      --timer-bg: rgba(59, 7, 100, 0.08);
    }

    body { background:#f5f5f8; font-family:"Inter",system-ui,sans-serif; }
    .exam-shell { max-width: 1120px; margin: 2rem auto; }
    .cover-card,
    .question-card { background:#fff; border-radius:14px; padding:24px; margin-bottom:24px; box-shadow:0 2px 16px rgba(15,23,42,0.08); position:relative; overflow:hidden; }
    .question-card { border-left:5px solid #552a74; }
    .question-card h5 { font-weight:600; color:#552a74; }
    .answer-area textarea { width:100%; border-radius:10px; border:1px solid #d6d6f4; padding:14px 16px; min-height:150px; font-size:1rem; resize:vertical; }
    .answer-area textarea:focus { border-color:#552a74; box-shadow:0 0 0 3px rgba(85,42,116,0.12); }
    .stats-pill { background:rgba(79,70,229,0.1); color:#312e81; padding:5px 14px; border-radius:999px; font-size:0.85rem; margin-right:10px; }

    .surface-wrapper { position:relative; }
    .note-surface { position:relative; z-index:1; pointer-events:none; }
    .note-surface * { pointer-events:auto; } /* keep links/images interactive */
    .writing-overlay {
      position:absolute;
      inset:0;
      z-index:2;
      pointer-events:none;
    }
    .writing-overlay[data-active="true"] {
      pointer-events:auto;
    }
    .writing-block {
      position:absolute;
      min-width:220px;
      min-height:120px;
      padding:14px 16px;
      background:rgba(255,250,229,0.96);
      border:2px solid rgba(250,204,21,0.8);
      border-radius:12px;
      box-shadow:0 8px 20px rgba(15,23,42,0.12);
      color:#1f2937;
      font-size:1rem;
      line-height:1.55;
      overflow:auto;
      resize:both;
      cursor:text;
      opacity:.65;
      transition:opacity .2s ease, box-shadow .2s ease;
    }
    .writing-block:focus {
      outline:3px solid var(--overlay-focus);
      background:#fffef5;
      opacity:1;
    }

    .pdf-content .pdf-node { margin-bottom:1.2rem; border-bottom:1px solid #e5e7eb; padding-bottom:1rem; }
    .pdf-content .pdf-node__header { display:flex; gap:0.75rem; align-items:baseline; font-weight:600; color:#111827; margin-bottom:0.5rem; }
    .pdf-content .pdf-node__number { font-size:1rem; color:#3a063a; }
    .pdf-content .pdf-node__type { font-size:0.8rem; text-transform:uppercase; letter-spacing:0.05em; color:#6b7280; }
    .pdf-content .pdf-node__marks { font-size:0.8rem; color:#047857; margin-left:auto; }
    .pdf-content .pdf-node__text { margin:0.35rem 0; }
    .pdf-content .pdf-node__table { margin:0.75rem 0; width:100%; border-collapse:collapse; font-size:0.9rem; }
    .pdf-content .pdf-node__table table { width:100%; border-collapse:collapse; }
    .pdf-content .pdf-node__table td,
    .pdf-content .pdf-node__table th { border:1px solid #d1d5db; padding:6px; }
    .pdf-content .pdf-node__children { margin-left:1.5rem; border-left:2px solid rgba(58,6,58,0.15); padding-left:1rem; margin-top:0.5rem; }

    .answer-panel {
      background:#fff;
      border-radius:14px;
      box-shadow:0 1px 12px rgba(15,23,42,0.08);
      padding:18px;
      position:fixed;
      top:120px;
      right:2.5vw;
      width:min(380px, 26vw);
      max-height:calc(100vh - 160px);
      overflow:auto;
      z-index:30;
      transition:transform .25s ease, opacity .2s ease;
      transform:translateX(120%);
      opacity:0;
      pointer-events:none;
    }
    .answer-panel.visible { transform:translateX(0); opacity:1; pointer-events:auto; }
    .answer-panel h4 { font-size:1rem; font-weight:600; color:#3a063a; margin-right:2.25rem; }
    .answer-panel .accordion-button { font-weight:600; }
    .answer-panel textarea { width:100%; border-radius:10px; border:1px solid #d6d6f4; padding:12px 14px; min-height:140px; font-size:1rem; resize:vertical; }
    .answer-panel textarea:focus { border-color:#552a74; box-shadow:0 0 0 3px rgba(85,42,116,0.12); }
    .answer-panel-toggle {
      position:fixed;
      top:120px;
      right:calc(min(380px, 26vw) + 4vw);
      z-index:31;
    }

    .outline-panel {
      border-top:1px solid #e5e7eb;
      margin-top:1.5rem;
      padding-top:1.25rem;
    }
    .outline-panel-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:0.75rem;
      margin-bottom:0.75rem;
    }
    .outline-panel-header h5 {
      font-size:0.95rem;
      font-weight:600;
      color:#3a063a;
    }
    .outline-panel-note {
      font-size:0.8rem;
      color:#64748b;
    }
    .outline-section {
      background:#f8fafc;
      border:1px solid #dbeafe;
      border-radius:12px;
      padding:1rem;
      margin-bottom:1rem;
    }
    .outline-section:last-child {
      margin-bottom:0;
    }
    .outline-section-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:0.75rem;
      margin-bottom:0.75rem;
    }
    .outline-section-title {
      font-weight:600;
      color:#312e81;
      font-size:0.95rem;
    }
    .outline-items {
      display:flex;
      flex-direction:column;
      gap:0.75rem;
    }
    .outline-item {
      background:#fff;
      border:1px solid #e0e7ff;
      border-radius:10px;
      padding:0.75rem;
    }
    .outline-item-label {
      font-size:0.75rem;
      letter-spacing:0.05em;
      text-transform:uppercase;
      margin-bottom:0.5rem;
    }
    .outline-item textarea {
      font-size:0.9rem;
      min-height:72px;
      resize:vertical;
    }
    .outline-item-actions {
      display:flex;
      justify-content:flex-end;
      margin-top:0.5rem;
    }
    .outline-empty {
      border:1px dashed #c7d2fe;
      border-radius:10px;
      padding:0.75rem;
      text-align:center;
      font-size:0.85rem;
      color:#64748b;
    }

    .question-card table, .cover-card table {
      width:100%;
      display:block;
      overflow:auto;
      resize:both;
      border:1px solid #cbd5f5;
      border-radius:6px;
      margin-bottom:1rem;
    }
    .question-card table td,
    .question-card table th,
    .cover-card table td,
    .cover-card table th {
      min-width:120px;
      vertical-align:top;
      padding:10px;
    }

    .toolbar {
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background:#fff;
      border-radius:14px;
      padding:18px 24px;
      margin-bottom:24px;
      box-shadow:0 1px 12px rgba(15,23,42,0.08);
    }

    .toolbar .form-check-input:checked {
      background-color:#552a74;
      border-color:#552a74;
    }

    .timer-pill {
      display:flex;
      align-items:center;
      gap:6px;
      background:var(--timer-bg);
      color:#3b0764;
      padding:8px 16px;
      border-radius:999px;
      font-weight:600;
      font-family:"JetBrains Mono","Fira Code",monospace;
      letter-spacing:0.08em;
    }

    .autosave-indicator {
      font-size:0.85rem;
      color:#64748b;
    }
    .autosave-indicator[data-status="saving"] { color:#0f766e; }
    .autosave-indicator[data-status="error"] { color:#b91c1c; }

    /* Submission protection styles */
    .submission-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-size: 1.5rem;
      text-align: center;
    }
    
    .submission-message {
      background: white;
      color: black;
      padding: 2rem;
      border-radius: 10px;
      max-width: 500px;
    }
    
    .warning-banner {
      background: #ffeb3b;
      color: #333;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 2px solid #ffc107;
      display: none; /* Hidden by default */
    }

    .exam-submitted {
      opacity: 0.6;
      pointer-events: none;
    }

    /* Prevent sticky notes from appearing on click */
    .writing-overlay.disabled {
      pointer-events: none !important;
    }
  </style>
</head>
<body>
  <!-- Warning Banner - Hidden by default -->
  <div class="warning-banner" id="warningBanner">
    ⚠️ Warning: Navigating away from this page will automatically submit your exam!
  </div>

  <!-- Submission Overlay -->
  <div class="submission-overlay" id="submissionOverlay">
    <div class="submission-message">
      <h3>Submitting Your Exam</h3>
      <p>Please wait while your exam is being submitted...</p>
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  </div>

  <div class="exam-shell" id="examContainer">
    <div class="toolbar">
      <div class="d-flex flex-wrap gap-3 align-items-center">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="toggleOverlay" checked>
          <label class="form-check-label fw-semibold" for="toggleOverlay">Enable writing layer</label>
        </div>
        <div class="autosave-indicator" id="autosaveStatus" data-status="idle">Autosave ready</div>
      </div>
      <div class="timer-pill">
        <span class="me-1"><i class="fas fa-clock"></i></span>
        <span id="countdownClock">03:00:00</span>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="mb-1">{{ assessment.paper }}</h2>
        <div class="text-muted">{{ assessment.qualification.name|default:"Qualification not set" }}</div>
        {% if random_meta.status %}
          <div class="text-muted small">Randomization status: {{ random_meta.status }}</div>
        {% endif %}
        {% if random_meta.snapshot_pool_used %}
          <span class="badge bg-info text-dark">Snapshot pool variant</span>
        {% endif %}
      </div>
      <div class="text-end">
        <div class="stats-pill">Total Questions: {{ node_stats.questions }}</div>
        <div class="text-muted small">Attempt {{ attempt_number }}</div>
      </div>
    </div>

    <form id="exam-form" method="post" action="{% url 'submit_exam' assessment_id=assessment.id %}">
      {% csrf_token %}
      <input type="hidden" name="attempt_number" value="{{ attempt_number }}">

      {% if node_sequence %}
        {% if is_randomized %}
        <div class="cover-card">
          <div class="surface-wrapper">
            <div class="note-surface pdf-content">
              {% for node in node_sequence %}
                {% include 'core/assessor-developer/_pdf_node.html' with node=node %}
              {% endfor %}
            </div>
            <div class="writing-overlay disabled" data-overlay="notes_document" data-active="false" tabindex="-1" aria-label="Write on assessment document"></div>
          </div>
          <input type="hidden" name="notes_document" value="">
        </div>
        {% else %}
          {% for node in node_sequence %}
            {% with lower_type=node.node_type|default:''|lower %}
            {% with node_identifier=node.template_id|default:forloop.counter %}
            {% if lower_type == 'question' %}
            <div class="question-card" data-node-id="{{ node_identifier }}" data-node-type="{{ lower_type }}">
            {% else %}
            <div class="cover-card" data-node-id="{{ node_identifier }}" data-node-type="{{ lower_type }}">
            {% endif %}
              <div class="surface-wrapper mb-3">
                <div class="note-surface">
                  {% include 'core/administrator/_readonly_node.html' with node=node %}
                </div>
                <div class="writing-overlay disabled" data-overlay="notes_node_{{ node_identifier }}" data-active="false" tabindex="-1" aria-label="Write on {{ lower_type|default:'content' }}"></div>
              </div>
              <input type="hidden" name="notes_node_{{ node_identifier }}" value="">

            </div>
            {% endwith %}
            {% endwith %}
          {% endfor %}
        {% endif %}
      {% else %}
        <div class="alert alert-warning">No structured content is available for this assessment.</div>
      {% endif %}

      {% if question_nodes %}
        <button class="btn btn-outline-primary answer-panel-toggle" type="button" id="answerPanelToggle" aria-expanded="false">
          <i class="fas fa-edit me-1"></i> Answer Summary
        </button>
        <div class="answer-panel" id="answerPanel" aria-hidden="true">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Answer Summary</h4>
            <button type="button" class="btn-close" id="answerPanelClose" aria-label="Close summary panel"></button>
          </div>
          <div class="accordion" id="answerAccordion">
            {% for qnode in question_nodes %}
              {% with qid=qnode.template_id|default:forloop.counter %}
              {% with panel_id=qid|slugify %}
              <div class="accordion-item">
                <h2 class="accordion-header" id="answerHeading{{ panel_id }}">
                  <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#answerCollapse{{ panel_id }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="answerCollapse{{ panel_id }}">
                    Question {{ qnode.number|default:forloop.counter }}
                  </button>
                </h2>
                <div id="answerCollapse{{ panel_id }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" aria-labelledby="answerHeading{{ panel_id }}" data-bs-parent="#answerAccordion">
                  <div class="accordion-body">
                    {% if is_randomized %}
                      <textarea id="answer_node_{{ qid }}" name="answer_node_{{ qid }}" placeholder="Capture the key points of your response..." data-autosize="true"></textarea>
                    {% else %}
                      <textarea class="form-control answer-summary-field" data-linked="answer_node_{{ qid }}" placeholder="Capture the key points of your response..." data-autosize="true"></textarea>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endwith %}
              {% endwith %}
            {% endfor %}
          </div>
          <div class="outline-panel" id="answerOutlinePanel" aria-live="polite">
            <div class="outline-panel-header">
              <h5 class="mb-0">Answer Outline</h5>
              <button type="button" class="btn btn-sm btn-outline-secondary" id="outlineResetButton">
                <i class="fas fa-undo-alt me-1"></i>Reset Outline
              </button>
            </div>
            <div class="outline-panel-note">
              Use the outline to plan sub-points for key questions. Add children beneath each parent number and capture quick notes without affecting your main answers.
            </div>
            <div class="outline-sections" id="answerOutline"></div>
            <input type="hidden" name="answer_outline_payload" id="answerOutlinePayload" value="">
          </div>
        </div>
      {% elif not node_sequence and generated_qs %}
        <div class="question-card">
          <h5 class="mb-3">Legacy Questions</h5>
          {% for q in generated_qs %}
            <div class="mb-4">
              <div class="surface-wrapper mb-2">
                <div class="note-surface">
                  <strong>Question {{ forloop.counter }}{% if q.marks %} ({{ q.marks }} marks){% endif %}:</strong>
                  <p>{{ q.text }}</p>
                </div>
                <div class="writing-overlay disabled" data-overlay="notes_legacy_{{ q.id }}" data-active="false" tabindex="-1" aria-label="Write directly on legacy question {{ forloop.counter }}"></div>
              </div>
              <input type="hidden" name="notes_legacy_{{ q.id }}" value="">
              <label class="form-label" for="answer_{{ q.id }}">Summary / final answer</label>
              <textarea id="answer_{{ q.id }}" name="answer_{{ q.id }}" rows="4" class="form-control" data-autosize="true"></textarea>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="text-center my-4">
        <button type="submit" class="btn btn-success btn-lg px-5" id="submitBtn">Submit</button>
      </div>
    </form>
  </div>

 <script>
  // ==================== SUBMISSION PROTECTION ====================
  const examForm = document.getElementById('exam-form');
  const submissionOverlay = document.getElementById('submissionOverlay');
  const warningBanner = document.getElementById('warningBanner');
  const submitBtn = document.getElementById('submitBtn');
  const examContainer = document.getElementById('examContainer');

  let isSubmitting = false;
  let hasChanges = false;
  let forceSubmitted = false;

  // Track form changes
  const formInputs = examForm.querySelectorAll('input, textarea, select');
  formInputs.forEach(input => {
    if (input.name !== 'csrfmiddlewaretoken') {
      input.addEventListener('input', () => {
        hasChanges = true;
        // Show warning banner when user starts typing
        if (!warningBanner.style.display || warningBanner.style.display === 'none') {
          warningBanner.style.display = 'block';
        }
      });
      input.addEventListener('change', () => {
        hasChanges = true;
      });
    }
  });

  // Function to submit the form
  function submitExam() {
    if (isSubmitting || forceSubmitted) return;

    isSubmitting = true;
    forceSubmitted = true;
    submissionOverlay.style.display = 'flex';
    warningBanner.style.display = 'none';
    examContainer.classList.add('exam-submitted');

    // Disable all form inputs
    formInputs.forEach(input => {
      input.disabled = true;
    });
    submitBtn.disabled = true;

    // Final sync before submission
    syncOverlaysToHidden();
    clearAutosave();

    // Submit the form normally - let Django handle the redirect
    examForm.submit();
  }

  // Prevent back button
  window.history.pushState(null, null, window.location.href);
  window.addEventListener('popstate', function (event) {
    if (hasChanges && !isSubmitting && !forceSubmitted) {
      window.history.pushState(null, null, window.location.href);
      submitExam(); // Auto submit without confirmation
    }
  });

  // Handle page refresh/reload
  window.addEventListener('beforeunload', function (e) {
    if (hasChanges && !isSubmitting && !forceSubmitted) {
      e.preventDefault();
      // Don't show confirmation, just submit
      submitExam();
      // Return nothing to prevent the default dialog
      return undefined;
    }
  });

  // Handle page visibility change (tab switch)
  document.addEventListener('visibilitychange', function () {
    if (document.hidden && hasChanges && !isSubmitting && !forceSubmitted) {
      submitExam();
    }
  });

  // Handle F5 and Ctrl+R
  document.addEventListener('keydown', function (e) {
    if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
      if (hasChanges && !isSubmitting && !forceSubmitted) {
        e.preventDefault();
        submitExam();
      }
    }

    // Prevent Ctrl+W (close tab) without submission
    if (e.ctrlKey && e.key === 'w') {
      if (hasChanges && !isSubmitting && !forceSubmitted) {
        e.preventDefault();
        submitExam();
      }
    }
  });

  // Regular form submission - let it proceed normally
  examForm.addEventListener('submit', function (e) {
    if (!isSubmitting && !forceSubmitted) {
      // Just do the final preparations, then let the form submit normally
      syncOverlaysToHidden();
      clearAutosave();
      isSubmitting = true;
      forceSubmitted = true;
      submissionOverlay.style.display = 'flex';
      // Don't prevent default - let the form submit normally
    } else {
      e.preventDefault(); // Prevent if already submitting
    }
  });

  // ==================== EXISTING EXAM FUNCTIONALITY ====================
  const overlayToggle = document.getElementById('toggleOverlay');
  const overlays = Array.from(document.querySelectorAll('.writing-overlay'));
  const autosaveStatus = document.getElementById('autosaveStatus');
  const countdownClock = document.getElementById('countdownClock');
  const assessmentKey = 'assessment_{{ assessment.id|default:"0" }}_draft';
  const summaryToggle = document.getElementById('answerPanelToggle');
  const summaryPanel = document.getElementById('answerPanel');
  const summaryClose = document.getElementById('answerPanelClose');
  const outlinePanel = document.getElementById('answerOutlinePanel');
  const outlineContainer = document.getElementById('answerOutline');
  const outlinePayloadField = document.getElementById('answerOutlinePayload');
  const outlineResetButton = document.getElementById('outlineResetButton');
  let hydrateOutlineFromField = null;

  // Disable sticky notes functionality by default
  overlays.forEach(overlay => {
    overlay.classList.add('disabled');
    overlay.dataset.active = "false";
  });

  function setSummaryVisibility(show) {
    if (!summaryPanel) return;
    if (show) {
      summaryPanel.classList.add('visible');
      summaryPanel.setAttribute('aria-hidden', 'false');
      summaryToggle?.setAttribute('aria-expanded', 'true');
    } else {
      summaryPanel.classList.remove('visible');
      summaryPanel.setAttribute('aria-hidden', 'true');
      summaryToggle?.setAttribute('aria-expanded', 'false');
    }
  }

  if (summaryPanel) {
    setSummaryVisibility(false);
  }

  summaryToggle?.addEventListener('click', () => {
    const shouldShow = !(summaryPanel?.classList.contains('visible'));
    setSummaryVisibility(shouldShow);
  });
  summaryClose?.addEventListener('click', () => setSummaryVisibility(false));
  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
      setSummaryVisibility(false);
    }
  });

  /* Lightweight accordion behaviour for the answer summary (no Bootstrap JS) */
  const answerAccordion = document.getElementById('answerAccordion');
  if (answerAccordion) {
    const accordionButtons = Array.from(answerAccordion.querySelectorAll('.accordion-button'));
    const accordionPanels = Array.from(answerAccordion.querySelectorAll('.accordion-collapse'));

    const closeAllPanels = () => {
      accordionPanels.forEach((panel) => {
        panel.classList.remove('show');
        panel.setAttribute('aria-hidden', 'true');
      });
      accordionButtons.forEach((button) => {
        button.classList.add('collapsed');
        button.setAttribute('aria-expanded', 'false');
      });
    };

    /* Initialise aria state based on existing markup */
    accordionPanels.forEach((panel) => {
      panel.setAttribute('aria-hidden', panel.classList.contains('show') ? 'false' : 'true');
    });
    accordionButtons.forEach((button) => {
      const targetSelector = button.getAttribute('data-bs-target');
      const panel = targetSelector ? document.querySelector(targetSelector) : null;
      if (!panel) return;
      button.addEventListener('click', (event) => {
        event.preventDefault();
        const willClose = panel.classList.contains('show');
        closeAllPanels();
        if (!willClose) {
          panel.classList.add('show');
          panel.setAttribute('aria-hidden', 'false');
          button.classList.remove('collapsed');
          button.setAttribute('aria-expanded', 'true');
        }
      });
    });
  }

  function linkSummaryFields() {
    const summaryFields = document.querySelectorAll('.answer-summary-field[data-linked]');
    summaryFields.forEach((summaryField) => {
      const targetId = summaryField.dataset.linked;
      if (!targetId) return;
      let target = document.getElementById(targetId);
      if (!(target instanceof HTMLTextAreaElement)) {
        target = document.createElement('textarea');
        target.id = targetId;
        target.name = targetId;
        target.style.display = 'none';
        examForm?.appendChild(target);
      }

      const resizeField = (field) => {
        if (!field) return;
        field.style.height = 'auto';
        field.style.height = (field.scrollHeight + 6) + 'px';
      };

      let syncing = false;
      const syncFromTarget = () => {
        if (syncing) return;
        syncing = true;
        summaryField.value = target.value;
        resizeField(summaryField);
        syncing = false;
      };
      const syncToTarget = () => {
        if (syncing) return;
        syncing = true;
        target.value = summaryField.value;
        target.dispatchEvent(new Event('input', { bubbles: true }));
        resizeField(summaryField);
        syncing = false;
      };

      target.addEventListener('input', syncFromTarget);
      summaryField.addEventListener('input', syncToTarget);
      syncFromTarget();
    });
  }
  linkSummaryFields();

  if (outlinePanel && outlineContainer && outlinePayloadField) {
    const DEFAULT_OUTLINE_ROOTS = ['1.1', '2.1'];

    const makeDefaultOutlineState = () => DEFAULT_OUTLINE_ROOTS.map((id) => ({
      id,
      counter: 1,
      children: [],
    }));

    let outlineState = makeDefaultOutlineState();

    const updateOutlineField = () => {
      if (!outlinePayloadField) {
        return;
      }
      const payload = outlineState.map((root) => ({
        id: root.id,
        children: root.children.map((child) => ({
          id: child.id,
          text: child.text || '',
        })),
      }));
      try {
        outlinePayloadField.value = JSON.stringify(payload);
      } catch (err) {
        outlinePayloadField.value = '[]';
      }
    };

    function addChildToRoot(rootId, presetValue = '') {
      const root = outlineState.find((item) => item.id === rootId);
      if (!root) {
        return;
      }
      const childNumber = `${root.id}.${root.counter}`;
      root.counter += 1;
      root.children.push({
        id: childNumber,
        text: presetValue || '',
      });
      renderOutline();
      autosaveNow();
    }

    function removeChildFromRoot(rootId, childId) {
      const root = outlineState.find((item) => item.id === rootId);
      if (!root) {
        return;
      }
      root.children = root.children.filter((child) => child.id !== childId);
      renderOutline();
      autosaveNow();
    }

    function renderOutline() {
      if (!outlineContainer) {
        return;
      }
      outlineContainer.innerHTML = '';
      const fragment = document.createDocumentFragment();

      outlineState.forEach((root) => {
        const section = document.createElement('div');
        section.className = 'outline-section';

        const header = document.createElement('div');
        header.className = 'outline-section-header';

        const title = document.createElement('div');
        title.className = 'outline-section-title';
        title.textContent = `Parent ${root.id}`;
        header.appendChild(title);

        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'btn btn-sm btn-outline-primary';
        addBtn.innerHTML = '<i class="fas fa-plus"></i> Add sub-point';
        addBtn.addEventListener('click', () => addChildToRoot(root.id));
        header.appendChild(addBtn);

        section.appendChild(header);

        const itemsWrap = document.createElement('div');
        itemsWrap.className = 'outline-items';

        if (!root.children.length) {
          const placeholder = document.createElement('div');
          placeholder.className = 'outline-empty';
          placeholder.textContent = 'No sub-points yet. Use "Add sub-point" to start.';
          itemsWrap.appendChild(placeholder);
        } else {
          root.children.forEach((child) => {
            const item = document.createElement('div');
            item.className = 'outline-item';

            const label = document.createElement('div');
            label.className = 'outline-item-label';
            label.textContent = child.id;
            item.appendChild(label);

            const textarea = document.createElement('textarea');
            textarea.className = 'form-control outline-item-textarea';
            textarea.rows = 3;
            textarea.placeholder = 'Capture quick notes for this sub-point...';
            textarea.value = child.text || '';
            textarea.addEventListener('input', () => {
              child.text = textarea.value;
              updateOutlineField();
              autosaveNow();
            });
            item.appendChild(textarea);

            const actions = document.createElement('div');
            actions.className = 'outline-item-actions';
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-sm btn-outline-danger';
            removeBtn.innerHTML = '<i class="fas fa-minus"></i>';
            removeBtn.setAttribute('aria-label', `Remove ${child.id}`);
            removeBtn.addEventListener('click', () => removeChildFromRoot(root.id, child.id));
            actions.appendChild(removeBtn);
            item.appendChild(actions);

            itemsWrap.appendChild(item);
          });
        }

        section.appendChild(itemsWrap);
        fragment.appendChild(section);
      });

      outlineContainer.appendChild(fragment);
      updateOutlineField();
    }

    hydrateOutlineFromField = () => {
      outlineState = makeDefaultOutlineState();
      const raw = outlinePayloadField.value;
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            parsed.forEach((entry) => {
              if (!entry || typeof entry.id !== 'string') {
                return;
              }
              const target = outlineState.find((root) => root.id === entry.id);
              if (!target) {
                return;
              }
              const children = Array.isArray(entry.children) ? entry.children : [];
              const normalized = [];
              let maxSuffix = 0;
              children.forEach((child) => {
                if (!child || typeof child.id !== 'string') {
                  return;
                }
                const suffix = parseInt(child.id.split('.').pop() || '', 10);
                if (Number.isFinite(suffix)) {
                  maxSuffix = Math.max(maxSuffix, suffix);
                }
                normalized.push({
                  id: child.id,
                  text: typeof child.text === 'string' ? child.text : '',
                });
              });
              target.children = normalized;
              target.counter = Math.max(maxSuffix + 1, 1);
            });
          }
        } catch (err) {
          outlineState = makeDefaultOutlineState();
        }
      }
      renderOutline();
    };

    outlineResetButton?.addEventListener('click', () => {
      outlineState = makeDefaultOutlineState();
      renderOutline();
      autosaveNow();
    });

    hydrateOutlineFromField();
  }

  /* Auto-resize answer textareas */
  document.querySelectorAll('textarea[data-autosize="true"]').forEach((ta) => {
    const autoResize = () => {
      ta.style.height = 'auto';
      ta.style.height = (ta.scrollHeight + 6) + 'px';
    };
    ta.addEventListener('input', autoResize);
    autoResize();
  });

  /* Serialize overlay contents into hidden inputs */
  function syncOverlaysToHidden() {
    overlays.forEach((overlay) => {
      const inputName = overlay.dataset.overlay;
      if (!inputName) return;
      const hiddenField = document.querySelector(`input[name="${inputName}"]`);
      if (!hiddenField) return;
      hiddenField.value = overlay.innerHTML;
    });
  }

  function applyOverlayState(active) {
    overlays.forEach((overlay) => {
      if (active) {
        overlay.classList.remove('disabled');
        overlay.dataset.active = "true";
      } else {
        overlay.classList.add('disabled');
        overlay.dataset.active = "false";
      }
    });
  }

  overlayToggle.addEventListener('change', () => {
    applyOverlayState(overlayToggle.checked);
  });
  // Start with overlays disabled
  applyOverlayState(false);
  overlayToggle.checked = false;

  /* Autosave to localStorage */
  function getDraftPayload() {
    syncOverlaysToHidden();
    const formData = new FormData(examForm);
    const payload = {};
    formData.forEach((value, key) => {
      payload[key] = value;
    });
    return payload;
  }

  function applyAutosaveState(state) {
    if (!state) return;
    Object.entries(state).forEach(([key, value]) => {
      const input = examForm.elements.namedItem(key);
      if (!input) return;
      if (input instanceof HTMLTextAreaElement || input instanceof HTMLInputElement) {
        input.value = value;
      }
    });
    if (typeof hydrateOutlineFromField === 'function') {
      hydrateOutlineFromField();
    }
    syncOverlaysToHidden();
  }

  function setAutosaveStatus(status, message) {
    autosaveStatus.dataset.status = status;
    autosaveStatus.textContent = message;
  }

  function autosaveNow() {
    if (isSubmitting || forceSubmitted) return;
    try {
      const payload = getDraftPayload();
      localStorage.setItem(assessmentKey, JSON.stringify(payload));
      const stamp = new Date().toLocaleTimeString();
      setAutosaveStatus('saving', `Saved locally at ${stamp}`);
      setTimeout(() => setAutosaveStatus('idle', 'Autosave ready'), 2500);
    } catch (err) {
      console.error(err);
      setAutosaveStatus('error', 'Autosave failed (check storage quota)');
    }
  }

  function clearAutosave() {
    try {
      localStorage.removeItem(assessmentKey);
    } catch (err) {
      console.warn('Unable to clear draft', err);
    }
  }

  (function restoreDraft() {
    try {
      const draft = localStorage.getItem(assessmentKey);
      if (draft) {
        applyAutosaveState(JSON.parse(draft));
        setAutosaveStatus('saving', 'Draft restored from device');
        setTimeout(() => setAutosaveStatus('idle', 'Autosave ready'), 3000);
      }
    } catch (err) {
      console.warn('Unable to restore draft', err);
    }
  })();

  document.querySelectorAll('textarea[data-autosize="true"]').forEach((ta) => ta.addEventListener('input', autosaveNow));
  setInterval(autosaveNow, 60000); /* fallback autosave every minute */

  /* Countdown clock */
  const threeHoursInSeconds = 3 * 60 * 60;
  let remaining = threeHoursInSeconds;
  setInterval(() => {
    remaining = Math.max(remaining - 1, 0);
    const hrs = String(Math.floor(remaining / 3600)).padStart(2, '0');
    const mins = String(Math.floor((remaining % 3600) / 60)).padStart(2, '0');
    const secs = String(remaining % 60).padStart(2, '0');
    countdownClock.textContent = `${hrs}:${mins}:${secs}`;
  }, 1000);

  // Utility function
  function clamp(value, min, max) {
    return Math.min(Math.max(value, min), max);
  }
</script>
</body>
</html>